<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":5,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="iOS 开发相关日常总结记录。">
<meta property="og:type" content="website">
<meta property="og:title" content="HuiYouHua">
<meta property="og:url" content="http://example.com/page/4/index.html">
<meta property="og:site_name" content="HuiYouHua">
<meta property="og:description" content="iOS 开发相关日常总结记录。">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="HuiYou Hua">
<meta property="article:tag" content="Object-C, Swift, SwiftUI, Rust">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>HuiYouHua</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="HuiYouHua" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">HuiYouHua</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/HuiYouHua" class="github-corner" title="Follow me on github" aria-label="Follow me on github" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/12/03/%E6%95%99%E4%BD%A0%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E7%BB%84%E4%BB%B6%E5%8C%96%E9%A1%B9%E7%9B%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/android-chrome-384x384.png">
      <meta itemprop="name" content="HuiYou Hua">
      <meta itemprop="description" content="iOS 开发相关日常总结记录。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuiYouHua">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/03/%E6%95%99%E4%BD%A0%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E7%BB%84%E4%BB%B6%E5%8C%96%E9%A1%B9%E7%9B%AE/" class="post-title-link" itemprop="url">教你从零到一搭建组件化项目</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-12-03 00:01:53" itemprop="dateCreated datePublished" datetime="2018-12-03T00:01:53+08:00">2018-12-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BB%84%E4%BB%B6%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">组件化</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>组件化的目的就是为了在项目越做越大的时候，进行项目的解耦，在需要加入模块的时候直接pod，不需要是直接删除pod即可，方便快捷，使得项目模块清晰，更加可以自由复用。 </p>
<p>前篇介绍了怎么用<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/9975a364b476">Cococapods搭建私有仓库</a>，这里我们就用这种方式去搭建我们的组件化项目。</p>
</blockquote>
<h2 id="一、概览"><a href="#一、概览" class="headerlink" title="一、概览"></a>一、概览</h2><p>  搭建组件化项目我们首先需要一个组件的调度中心，这里我借用了casatwy的<a target="_blank" rel="noopener" href="https://github.com/casatwy/CTMediator">CTMediator</a>，同时也可以看看他对于组件化项目的讲解，<a target="_blank" rel="noopener" href="https://casatwy.com/iOS-Modulization.html" title="Permalink to iOS应用架构谈 组件化方案">iOS应用架构谈 组件化方案</a>]。<br>其次我建立一个主工程HHYMainComponent，还有三个组件模块：HHYComponentA、HHYComponentB、HHYComponentC。</p>
<p>关系如下：</p>
<p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220519235319858.png" alt="Snip20181203_1.png"></p>
<p>下面就开始搭建我们的项目。</p>
<h2 id="二、搭建项目"><a href="#二、搭建项目" class="headerlink" title="二、搭建项目"></a>二、搭建项目</h2><h4 id="1-创建调度中心"><a href="#1-创建调度中心" class="headerlink" title="1. 创建调度中心"></a>1. 创建调度中心</h4><p>这里我们用CTMediator作为我们的调度中心，创建一个文件夹放入核心代码，初始化podspec文件，并上传到github上。这里不太清楚podspec的可以先去看下前篇文章：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/9975a364b476">Cococapods搭建私有仓库</a></p>
<h4 id="2-创建模块及主工程"><a href="#2-创建模块及主工程" class="headerlink" title="2.创建模块及主工程"></a>2.创建模块及主工程</h4><p>这里每个模块及工程我们各建一个空工程，初始化pod及podspec。<br>到这里我们的项目工程都搭建出来了。下面我们开始分析模块化怎么搭建。</p>
<h4 id="3-搭建模块ABC"><a href="#3-搭建模块ABC" class="headerlink" title="3.搭建模块ABC"></a>3.搭建模块ABC</h4><p>这里我们以我搭建的HHYComponentA项目为例来讲解。<br>首先我搭建的模块项目目录结构如下：</p>
<p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220519235319903.png" alt="Snip20181203_2.png"></p>
<p>一级目录里我们有 podspec 以及 MIT 证书文件，另跟github上的项目关联了，其次二级目录里我们除了初始化的项目工程文件外我们还建了四个文件夹：Controller、CTMediaCategory、Model、Target。<br>这里关于Model文件是我用来做对象类型传值用的，没什么用，暂且不谈了，主要是另外几个文件。</p>
<ul>
<li>Controller：就是我们的模块化控制器</li>
<li>CTMediaCategory：是我们的调度中心CTMediator的一个分类，它主要负责消息的转发及参数的传递。</li>
<li>Target：它负责通过消息转发之后的消息处理，进行控制器对象的创建并返回。</li>
</ul>
<p>这个就是我们创建好后的工程目录结构：</p>
<p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220519235320039.png" alt="Snip20181203_3.png"></p>
<h5 id="1）CTMediator-HHYComponentA"><a href="#1）CTMediator-HHYComponentA" class="headerlink" title="1）CTMediator+HHYComponentA"></a>1）CTMediator+HHYComponentA</h5><p>这里我们先看CTMediator+HHYComponentA文件<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (UIViewController *)HHYComponentA:(HHYUser *)user &#123;</span><br><span class="line">    NSMutableDictionary *params = [[NSMutableDictionary alloc] init];</span><br><span class="line">    params[@&quot;user&quot;] = user;</span><br><span class="line">    return [self performTarget:@&quot;HHYComponentA&quot; action:@&quot;HHYComponentA&quot; params:params shouldCacheTarget:NO];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>这里我们通过调用调度中心的<strong>performTarget： action： params: shouldCacheTarget:</strong>方法将参数传递进去，同时返回一个控制器。我们进入这个方法看一下。<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">- (id)performTarget:(NSString *)targetName action:(NSString *)actionName params:(NSDictionary *)params shouldCacheTarget:(BOOL)shouldCacheTarget</span><br><span class="line">&#123;</span><br><span class="line">    NSString *swiftModuleName = params[kCTMediatorParamsKeySwiftTargetModuleName];</span><br><span class="line">    </span><br><span class="line">    // generate target</span><br><span class="line">    NSString *targetClassString = nil;</span><br><span class="line">    if (swiftModuleName.length &gt; 0) &#123;</span><br><span class="line">        targetClassString = [NSString stringWithFormat:@&quot;%@.Target_%@&quot;, swiftModuleName, targetName];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        targetClassString = [NSString stringWithFormat:@&quot;Target_%@&quot;, targetName];</span><br><span class="line">    &#125;</span><br><span class="line">    NSObject *target = self.cachedTarget[targetClassString];</span><br><span class="line">    if (target == nil) &#123;</span><br><span class="line">        Class targetClass = NSClassFromString(targetClassString);</span><br><span class="line">        target = [[targetClass alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // generate action</span><br><span class="line">    NSString *actionString = [NSString stringWithFormat:@&quot;Action_%@:&quot;, actionName];</span><br><span class="line">    SEL action = NSSelectorFromString(actionString);</span><br><span class="line">    </span><br><span class="line">    if (target == nil) &#123;</span><br><span class="line">        // 这里是处理无响应请求的地方之一，这个demo做得比较简单，如果没有可以响应的target，就直接return了。实际开发过程中是可以事先给一个固定的target专门用于在这个时候顶上，然后处理这种请求的</span><br><span class="line">        [self NoTargetActionResponseWithTargetString:targetClassString selectorString:actionString originParams:params];</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if (shouldCacheTarget) &#123;</span><br><span class="line">        self.cachedTarget[targetClassString] = target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if ([target respondsToSelector:action]) &#123;</span><br><span class="line">        return [self safePerformAction:action target:target params:params];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // 这里是处理无响应请求的地方，如果无响应，则尝试调用对应target的notFound方法统一处理</span><br><span class="line">        SEL action = NSSelectorFromString(@&quot;notFound:&quot;);</span><br><span class="line">        if ([target respondsToSelector:action]) &#123;</span><br><span class="line">            return [self safePerformAction:action target:target params:params];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // 这里也是处理无响应请求的地方，在notFound都没有的时候，这个demo是直接return了。实际开发过程中，可以用前面提到的固定的target顶上的。</span><br><span class="line">            [self NoTargetActionResponseWithTargetString:targetClassString selectorString:actionString originParams:params];</span><br><span class="line">            [self.cachedTarget removeObjectForKey:targetClassString];</span><br><span class="line">            return nil;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>这里可以看到这个方法是对消息转发的一个操作，创建了一个Target_ targetName的对象，执行这个对象中的一个Action_actionName的一个方法，并对无target的一个保护操作。</p>
<h5 id="2）Target-HHYComponentA"><a href="#2）Target-HHYComponentA" class="headerlink" title="2）Target_HHYComponentA"></a>2）Target_HHYComponentA</h5><p>这个文件就是上面消息转发中对应Target_ targetName的对象，里面有一个对应的Action_actionName执行方法。<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (UIViewController *)Action_HHYComponentA:(NSDictionary *)params &#123;</span><br><span class="line">    HHYComponentAViewController *VC = [[HHYComponentAViewController alloc] init];</span><br><span class="line">    VC.user = params[@&quot;user&quot;];</span><br><span class="line">    return VC;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>这里返回就是我们创建的模块控制器，通过NSDictionary我们可以传递复杂的参数类型和方法的回调。</p>
<h5 id="3）HHYComponentAViewController"><a href="#3）HHYComponentAViewController" class="headerlink" title="3）HHYComponentAViewController"></a>3）HHYComponentAViewController</h5><p>这里面我没写什么，就打印了下传递的参数。</p>
<p>这样，我们的模块组件A就搭建完成了</p>
<h5 id="4）HHYComponentA-podspec"><a href="#4）HHYComponentA-podspec" class="headerlink" title="4）HHYComponentA.podspec"></a>4）HHYComponentA.podspec</h5><p>这里我们要说一下spec文件，我写的时候被这个文件搞的头大。<br>因为我们的调度中心是放在我们的私有仓库的，模块A引用了私有仓库的文件，而我们的模块又是要放在我们的私有仓库，所以就形成了<strong>私有仓库调用私有仓库</strong><br>因此，我们调用的私有仓库要在spec文件中声明，同时在终端验证的时候也要声明其来源。这个我们在上一篇文章中没有提及<br>另外项目的<strong>目录层级</strong>结构也要注意一下，下面就是我建的spec文件<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Pod::Spec.new do |s|</span><br><span class="line"></span><br><span class="line">  # 项目名称</span><br><span class="line">  s.name         = &quot;HHYComponentA&quot;</span><br><span class="line">  # 项目版本号</span><br><span class="line">  s.version      = &quot;0.0.7&quot;</span><br><span class="line">  # 项目摘要</span><br><span class="line">  s.summary      = &quot;HHYComponentA&quot;</span><br><span class="line">  # 详细描述</span><br><span class="line">  s.description  = &quot;HHYComponentA远程仓库&quot;</span><br><span class="line">  # 仓库主页地址</span><br><span class="line">  s.homepage     = &quot;https://github.com/HuiYouHua/HHYComponentA&quot;</span><br><span class="line"></span><br><span class="line">  # 证书</span><br><span class="line">  s.license      = &#123; :type =&gt; &quot;MIT&quot;, :file =&gt; &quot;LICENSE&quot; &#125;</span><br><span class="line"></span><br><span class="line">  # 作者名称邮箱地址</span><br><span class="line">  s.author             = &#123; &quot;华惠友&quot; =&gt; &quot;793316968@qq.com&quot; &#125;</span><br><span class="line"></span><br><span class="line">  # 平台版本号</span><br><span class="line">  s.platform     = :ios, &quot;8.0&quot;</span><br><span class="line"></span><br><span class="line">  # git源码地址</span><br><span class="line">  s.source       = &#123; :git =&gt; &quot;https://github.com/HuiYouHua/HHYComponentA.git&quot;, :tag =&gt; &quot;#&#123;s.version&#125;&quot; &#125;</span><br><span class="line"></span><br><span class="line">	s.source_files  = &quot;HHYComponentA/HHYComponentA.h&quot;</span><br><span class="line"></span><br><span class="line">	s.subspec &#x27;Controller&#x27; do |c|</span><br><span class="line">	 	c.source_files = &#x27;HHYComponentA/Controller/**/*.&#123;h,m&#125;&#x27;</span><br><span class="line">		c.dependency &quot;HHYComponentA/Model&quot;</span><br><span class="line">	end</span><br><span class="line"></span><br><span class="line">	s.subspec &#x27;Target&#x27; do |t|</span><br><span class="line">		t.source_files = &#x27;HHYComponentA/Target/**/*.&#123;h,m&#125;&#x27;</span><br><span class="line">		t.dependency &quot;HHYComponentA/Controller&quot;</span><br><span class="line">	end</span><br><span class="line">		</span><br><span class="line">	s.subspec &#x27;CTMediaCategory&#x27; do |ct|</span><br><span class="line">	  ct.source_files = &quot;HHYComponentA/CTMediaCategory/**/*.&#123;h,m&#125;&quot;</span><br><span class="line">	  ct.dependency &quot;HHYComponentA/Model&quot;</span><br><span class="line">		end</span><br><span class="line"></span><br><span class="line">	s.subspec &#x27;Model&#x27; do |m|</span><br><span class="line">	  m.source_files = &quot;HHYComponentA/Model/**/*.&#123;h,m&#125;&quot;</span><br><span class="line">		end</span><br><span class="line">      </span><br><span class="line">   s.public_header_files = &quot;HHYComponentA/HHYComponentA.h&quot;</span><br><span class="line"></span><br><span class="line">   # 对私有仓库引用的依赖说明</span><br><span class="line">   s.dependency &#x27;HHYCTMediator&#x27;, &#x27;~&gt; 0.0.3&#x27;</span><br><span class="line">   s.requires_arc     = true</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">end</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>这里面声明的文件就是后面我们<strong>pod install</strong>下来的文件，不需要传的文件就不需要声明了。</p>
<p>下面进行配置文件的验证及上传命令</p>
<ul>
<li><p><strong>pod lib lint —sources=私有spec索引地址,git spec索引地址  —allow-warnings  —use-libraries</strong></p>
</li>
<li><p><strong>pod repo push 本地spec索引名称 上传的spec文件 —sources=私有spec索引地址,git spec索引地址 —allow-warnings  —use-libraries</strong><br>eg：</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pod lib lint --sources=https://github.com/HuiYouHua/HHYSpecs.git,https://github.com/CocoaPods/Specs.git  --allow-warnings  --use-libraries</span><br><span class="line"></span><br><span class="line">pod repo push HHYSpecs HHYComponentA.podspec --sources=https://github.com/HuiYouHua/HHYSpecs.git,https://github.com/CocoaPods/Specs.git --allow-warnings  --use-libraries</span><br></pre></td></tr></table></figure>
<p>同样，其他的三个模块搭建方式基本差不多，我这里只是做了不同参数的处理。到了这里，我们就可以在我们主工程里调用搭建的三个模块了。</p>
<h2 id="三、主工程进行调用"><a href="#三、主工程进行调用" class="headerlink" title="三、主工程进行调用"></a>三、主工程进行调用</h2><p>模块A:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (IBAction)componentA:(id)sender &#123;</span><br><span class="line">    HHYUser *user = [HHYUser new];</span><br><span class="line">    user.name = @&quot;huayoyu&quot;;</span><br><span class="line">    user.age = 18;</span><br><span class="line">    UIViewController *vc = [[CTMediator sharedInstance] HHYComponentA:user];</span><br><span class="line">    [self.navigationController pushViewController:vc animated:YES];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>模块B：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (IBAction)componentB:(id)sender &#123;</span><br><span class="line">    NSArray *array = @[@&quot;1&quot;, @&quot;2&quot;, @&quot;3&quot;, @&quot;4&quot;];</span><br><span class="line">    UIViewController *vc = [[CTMediator sharedInstance] HHYComponentB:array WithCallback:^(NSArray * _Nonnull dataArray) &#123;</span><br><span class="line">        NSLog(@&quot;%@&quot;,dataArray);</span><br><span class="line">    &#125;];</span><br><span class="line">    [self.navigationController pushViewController:vc animated:YES];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>模块C:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (IBAction)componentC:(id)sender &#123;</span><br><span class="line">    UIViewController *vc = [[CTMediator sharedInstance] HHYComponentCWithCallback:^(NSString * _Nonnull result) &#123;</span><br><span class="line">        NSLog(@&quot;%@&quot;, result);</span><br><span class="line">    &#125;];</span><br><span class="line">    [self.navigationController pushViewController:vc animated:YES];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>这样，组件化项目大体就搭建完成了。如果要对模块的增删，只需要对podfile文件进行操作，对入口的增删即可。</p>
<p>当然，这个只是简单的组件化项目的搭建，真正的项目当然还设计到其他很多东西，比如网络层、数据库、公共视图层、分类、第三方、AOP。。。，这个就需要更深一步的了解了。</p>
<p>项目git传送门：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/HuiYouHua/HHYMainComponent">主工程</a><br><a target="_blank" rel="noopener" href="https://github.com/HuiYouHua/HHYComponentA">组件A</a><br><a target="_blank" rel="noopener" href="https://github.com/HuiYouHua/HHYComponentB">组件B</a><br><a target="_blank" rel="noopener" href="https://github.com/HuiYouHua/HHYComponentC">组件C</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/HuiYouHua/HHYCTMediator">组件调度中心</a><br><a target="_blank" rel="noopener" href="https://github.com/HuiYouHua/HHYSpecs">私有索引仓库HHYSpecs</a><br>喜欢的git给个star哦</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/11/28/Cocoapods%E5%BB%BA%E7%AB%8B%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/android-chrome-384x384.png">
      <meta itemprop="name" content="HuiYou Hua">
      <meta itemprop="description" content="iOS 开发相关日常总结记录。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuiYouHua">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/11/28/Cocoapods%E5%BB%BA%E7%AB%8B%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93/" class="post-title-link" itemprop="url">Cocoapods建立远程仓库</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-11-28 00:01:53" itemprop="dateCreated datePublished" datetime="2018-11-28T00:01:53+08:00">2018-11-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BB%84%E4%BB%B6%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">组件化</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p> 准备看看iOS的组件化，这里需要使用到Cocoapods进行建立仓库，所以学习了下后，就准备记录一下，方便以后自己进行操作。</p>
<p> 首先呢，肯定是要安装Cocoapods的，这里我们就不多说了</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/HuiYouHua/HHYRep">代码仓库</a><br><a target="_blank" rel="noopener" href="https://github.com/HuiYouHua/HHYSpecs">索引仓库</a></p>
<h2 id="一、创建远程仓库和工程"><a href="#一、创建远程仓库和工程" class="headerlink" title="一、创建远程仓库和工程"></a>一、创建远程仓库和工程</h2><h4 id="1-进入github创建一个项目，如图："><a href="#1-进入github创建一个项目，如图：" class="headerlink" title="1. 进入github创建一个项目，如图："></a>1. 进入<a target="_blank" rel="noopener" href="https://github.com">github</a>创建一个项目，如图：</h4><p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220519235128174.png" alt="Snip20181128_9.png"></p>
<p>这里的证书最好选择为MIT，不然后面可能有些小问题<br>    创建完成：</p>
<p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220519235128766.png" alt="Snip20181128_10.png"></p>
<p>这里我创建的项目叫<a target="_blank" rel="noopener" href="https://github.com/HuiYouHua/HHYRep">HHYRep</a></p>
<h4 id="2-创建项目"><a href="#2-创建项目" class="headerlink" title="2. 创建项目"></a>2. 创建项目</h4><p>打开终端，cd到桌面<br>输入命令<strong>pod lib create HHYRep</strong>，这里是通过pod创建一个项目，如下：</p>
<p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220519235130330.png" alt="Snip20181128_11.png"></p>
<p>这里会让你回答几个问题：</p>
<ul>
<li>你要使用哪个平台？ iOS</li>
<li>你要使用哪种语言？ ObjC</li>
<li>是否要使用示例？ YES</li>
<li>使用哪个测试框架？ None</li>
<li>是否要UI测试？ No</li>
<li>类名前缀是啥？ HHY</li>
</ul>
<p>回答完毕后就会创建工程，执行完自动打开工程，目录结构如下：</p>
<p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220519235130748.png" alt="Snip20181128_12.png"></p>
<p>其中Example就是我们的示例工程，HHYReq就是我们存放仓库代码的位置，里面默认创建有Assets和Classes两个文件夹，我们的代码文件就放在Classes里，图片资源文件可以放在Assets里。<br>另外还有生成的License证书和REAME文件。<br>其中比较重要的一个文件是HHYRep.podspec，这是我们关联远程仓库的一个配置文件，稍后我们将在里面进行部分修改。</p>
<h4 id="3-放入代码和资源文件"><a href="#3-放入代码和资源文件" class="headerlink" title="3. 放入代码和资源文件"></a>3. 放入代码和资源文件</h4><p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220519235131937.png" alt="Snip20181128_15.png"></p>
<p>加入代码文件，注意这里不要勾选target。</p>
<p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220519235132019.png" alt="Snip20181128_17.png"></p>
<p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220519235132064.png" alt="Snip20181128_18.png"></p>
<p>这里我添加了TimerHelper和UITableViewHelper两个文件，注意前面是有文件夹分层，如果需要在后续拉取后有文件层级关系，需要进行额外配置，后面有具体介绍。<br>  目录结构如下：</p>
<p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220519235132431.png" alt="Snip20181128_16.png"></p>
<p>另外，因为我们这里是创建了示例工程的，所以如果当你添加文件或者删除文件后，需要进入到Podfile同级目录下进行pod install，才可以引用引入的文件。</p>
<p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220519235132508.png" alt="Snip20181128_19.png"></p>
<h4 id="4-提交代码到刚刚创建的远程仓库"><a href="#4-提交代码到刚刚创建的远程仓库" class="headerlink" title="4. 提交代码到刚刚创建的远程仓库"></a>4. 提交代码到刚刚创建的远程仓库</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~/Desktop/HHYRep   master ●  git remote add origin https://github.com/HuiYouHua/HHYRep.git</span><br><span class="line">~/Desktop/HHYRep   master ●  git add .</span><br><span class="line">~/Desktop/HHYRep   master ✚  git commit -m -a</span><br><span class="line">~/Desktop/HHYRep   master  git push</span><br><span class="line">~/Desktop/HHYRep   master  git push -u origin </span><br><span class="line">~/Desktop/HHYRep   master  git tag 0.0.1</span><br><span class="line">~/Desktop/HHYRep   master  git push origin 0.0.1</span><br></pre></td></tr></table></figure>
<p>提交项目并打上版本号0.0.1，保持和HHYRep.podspec上的一致<br>这里提交除了点问题，但问题不大。<br>提交完之后，查看github上的工程目录如下:</p>
<p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220519235132991.png" alt="Snip20181128_20.png"></p>
<h2 id="二、关联仓库"><a href="#二、关联仓库" class="headerlink" title="二、关联仓库"></a>二、关联仓库</h2><h4 id="1-配置HHYRep-podspec文件"><a href="#1-配置HHYRep-podspec文件" class="headerlink" title="1. 配置HHYRep.podspec文件"></a>1. 配置HHYRep.podspec文件</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line">#  Be sure to run `pod spec lint HHYLib.podspec&#x27; to ensure this is a</span><br><span class="line">#  valid spec and to remove all comments including this before submitting the spec.</span><br><span class="line">#</span><br><span class="line">#  To learn more about Podspec attributes see http://docs.cocoapods.org/specification.html</span><br><span class="line">#  To see working Podspecs in the CocoaPods repo see https://github.com/CocoaPods/Specs/</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">Pod::Spec.new do |s|</span><br><span class="line"></span><br><span class="line">  # ―――  Spec Metadata  ―――――――――――――――――――――――――――――――――――――――――――――――――――――――――― #</span><br><span class="line">  #</span><br><span class="line">  #  These will help people to find your library, and whilst it</span><br><span class="line">  #  can feel like a chore to fill in it&#x27;s definitely to your advantage. The</span><br><span class="line">  #  summary should be tweet-length, and the description more in depth.</span><br><span class="line">  #</span><br><span class="line">  # 项目名称</span><br><span class="line">  s.name         = &quot;HHYRep&quot;</span><br><span class="line">  # 项目版本号</span><br><span class="line">  s.version      = &quot;0.0.1&quot;</span><br><span class="line">  # 项目摘要</span><br><span class="line">  s.summary      = &quot;HHYRep&quot;</span><br><span class="line"></span><br><span class="line">  # This description is used to generate tags and improve search results.</span><br><span class="line">  #   * Think: What does it do? Why did you write it? What is the focus?</span><br><span class="line">  #   * Try to keep it short, snappy and to the point.</span><br><span class="line">  #   * Write the description between the DESC delimiters below.</span><br><span class="line">  #   * Finally, don&#x27;t worry about the indent, CocoaPods strips it!</span><br><span class="line">  # 详细描述</span><br><span class="line">  s.description  = &quot;HHYRep远程仓库&quot;</span><br><span class="line"></span><br><span class="line">  # 仓库主页地址</span><br><span class="line">  s.homepage     = &quot;https://github.com/HuiYouHua/HHYRep&quot;</span><br><span class="line">  # s.screenshots  = &quot;www.example.com/screenshots_1.gif&quot;, &quot;www.example.com/screenshots_2.gif&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  # ―――  Spec License  ――――――――――――――――――――――――――――――――――――――――――――――――――――――――――― #</span><br><span class="line">  #</span><br><span class="line">  #  Licensing your code is important. See http://choosealicense.com for more info.</span><br><span class="line">  #  CocoaPods will detect a license file if there is a named LICENSE*</span><br><span class="line">  #  Popular ones are &#x27;MIT&#x27;, &#x27;BSD&#x27; and &#x27;Apache License, Version 2.0&#x27;.</span><br><span class="line">  #</span><br><span class="line"></span><br><span class="line">  # s.license      = &quot;MIT (example)&quot;</span><br><span class="line">  # 证书</span><br><span class="line">  s.license      = &#123; :type =&gt; &quot;MIT&quot;, :file =&gt; &quot;LICENSE&quot; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  # ――― Author Metadata  ――――――――――――――――――――――――――――――――――――――――――――――――――――――――― #</span><br><span class="line">  #</span><br><span class="line">  #  Specify the authors of the library, with email addresses. Email addresses</span><br><span class="line">  #  of the authors are extracted from the SCM log. E.g. $ git log. CocoaPods also</span><br><span class="line">  #  accepts just a name if you&#x27;d rather not provide an email address.</span><br><span class="line">  #</span><br><span class="line">  #  Specify a social_media_url where others can refer to, for example a twitter</span><br><span class="line">  #  profile URL.</span><br><span class="line">  #</span><br><span class="line">  # 作者名称邮箱地址</span><br><span class="line">  s.author             = &#123; &quot;华惠友&quot; =&gt; &quot;793316968@qq.com&quot; &#125;</span><br><span class="line">  # Or just: s.author    = &quot;华惠友&quot;</span><br><span class="line">  # s.authors            = &#123; &quot;华惠友&quot; =&gt; &quot;793316968@qq.com&quot; &#125;</span><br><span class="line">  # s.social_media_url   = &quot;http://twitter.com/华惠友&quot;</span><br><span class="line"></span><br><span class="line">  # ――― Platform Specifics ――――――――――――――――――――――――――――――――――――――――――――――――――――――― #</span><br><span class="line">  #</span><br><span class="line">  #  If this Pod runs only on iOS or OS X, then specify the platform and</span><br><span class="line">  #  the deployment target. You can optionally include the target after the platform.</span><br><span class="line">  #</span><br><span class="line"></span><br><span class="line">  # s.platform     = :ios</span><br><span class="line">  # 平台版本号</span><br><span class="line">  s.platform     = :ios, &quot;8.0&quot;</span><br><span class="line"></span><br><span class="line">  #  When using multiple platforms</span><br><span class="line">  # s.ios.deployment_target = &quot;5.0&quot;</span><br><span class="line">  # s.osx.deployment_target = &quot;10.7&quot;</span><br><span class="line">  # s.watchos.deployment_target = &quot;2.0&quot;</span><br><span class="line">  # s.tvos.deployment_target = &quot;9.0&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  # ――― Source Location ―――――――――――――――――――――――――――――――――――――――――――――――――――――――――― #</span><br><span class="line">  #</span><br><span class="line">  #  Specify the location from where the source should be retrieved.</span><br><span class="line">  #  Supports git, hg, bzr, svn and HTTP.</span><br><span class="line">  #</span><br><span class="line">  # git源码地址</span><br><span class="line">  s.source       = &#123; :git =&gt; &quot;https://github.com/HuiYouHua/HHYRep.git&quot;, :tag =&gt; &quot;#&#123;s.version&#125;&quot; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  # ――― Source Code ―――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――― #</span><br><span class="line">  #</span><br><span class="line">  #  CocoaPods is smart about how it includes source code. For source files</span><br><span class="line">  #  giving a folder will include any swift, h, m, mm, c &amp; cpp files.</span><br><span class="line">  #  For header files it will include any header in the folder.</span><br><span class="line">  #  Not including the public_header_files will make all headers public.</span><br><span class="line">  #</span><br><span class="line"></span><br><span class="line">  # 不分层的话就可以直接按照下面的写法</span><br><span class="line">  # s.source_files  = &quot;Classes&quot;, &quot;Classes/**/*.&#123;h,m&#125;&quot;</span><br><span class="line">  # s.exclude_files = &quot;Classes/**/*.h&quot;</span><br><span class="line"></span><br><span class="line">  # 代码文件</span><br><span class="line">  # 分层文件夹</span><br><span class="line">  s.subspec &#x27;TimerHelper&#x27; do |t|</span><br><span class="line">	t.subspec &#x27;GCD&#x27; do |gcd|</span><br><span class="line">	  gcd.source_files = &#x27;HHYRep/Classes/TimerHelper/GCD/**/*.&#123;h,m&#125;&#x27;</span><br><span class="line">	  # gcd.public_header_files = &#x27;Classes/TimerHelper/GCD/**/*.h&#x27;</span><br><span class="line">  	end</span><br><span class="line"></span><br><span class="line">  	t.subspec &#x27;NSTimer&#x27; do |nst|</span><br><span class="line">	  nst.source_files = &#x27;HHYRep/Classes/TimerHelper/NSTimer/**/*.&#123;h,m&#125;&#x27;</span><br><span class="line">	  # nst.public_header_files = &#x27;Classes/TimerHelper/NSTimer/**/*.h&#x27;</span><br><span class="line">  	end</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  s.subspec &#x27;UITableVIewHelper&#x27; do |uit|</span><br><span class="line">	  uit.source_files = &#x27;HHYRep/Classes/UITableVIewHelper/**/*.&#123;h,m&#125;&#x27;</span><br><span class="line">	  # gcd.public_header_files = &#x27;Classes/TimerHelper/GCD/**/*.h&#x27;</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  # s.public_header_files = &quot;Classes/**/*.h&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  # ――― Resources ―――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――― #</span><br><span class="line">  #</span><br><span class="line">  #  A list of resources included with the Pod. These are copied into the</span><br><span class="line">  #  target bundle with a build phase script. Anything else will be cleaned.</span><br><span class="line">  #  You can preserve files from being cleaned, please don&#x27;t preserve</span><br><span class="line">  #  non-essential files like tests, examples and documentation.</span><br><span class="line">  #</span><br><span class="line"></span><br><span class="line">  # 图片资源</span><br><span class="line">  # s.resource  = &quot;icon.png&quot;</span><br><span class="line">  s.resources = &quot;HHYRep/Resource/*.png&quot;</span><br><span class="line"></span><br><span class="line">  # s.preserve_paths = &quot;FilesToSave&quot;, &quot;MoreFilesToSave&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  # ――― Project Linking ―――――――――――――――――――――――――――――――――――――――――――――――――――――――――― #</span><br><span class="line">  #</span><br><span class="line">  #  Link your library with frameworks, or libraries. Libraries do not include</span><br><span class="line">  #  the lib prefix of their name.</span><br><span class="line">  #</span><br><span class="line"></span><br><span class="line">  # s.framework  = &quot;Foundation&quot;</span><br><span class="line">  # s.frameworks = &quot;SomeFramework&quot;, &quot;AnotherFramework&quot;</span><br><span class="line"></span><br><span class="line">  # s.library   = &quot;iconv&quot;</span><br><span class="line">  # s.libraries = &quot;iconv&quot;, &quot;xml2&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  # ――― Project Settings ――――――――――――――――――――――――――――――――――――――――――――――――――――――――― #</span><br><span class="line">  #</span><br><span class="line">  #  If your library depends on compiler flags you can set them in the xcconfig hash</span><br><span class="line">  #  where they will only apply to your library. If you depend on other Podspecs</span><br><span class="line">  #  you can include multiple dependencies to ensure it works.</span><br><span class="line"></span><br><span class="line">  s.requires_arc = true</span><br><span class="line"></span><br><span class="line">  # s.xcconfig = &#123; &quot;HEADER_SEARCH_PATHS&quot; =&gt; &quot;$(SDKROOT)/usr/include/libxml2&quot; &#125;</span><br><span class="line">  # s.dependency &quot;JSONKit&quot;, &quot;~&gt; 1.4&quot;</span><br><span class="line"></span><br><span class="line">end</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>注意这里面我进行的代码的分层，如果不分层的话则可以按照下面的写法：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 不分层的话就可以直接按照下面的写法</span><br><span class="line">  # s.source_files  = &quot;Classes&quot;, &quot;Classes/**/*.&#123;h,m&#125;&quot;</span><br><span class="line">  # s.exclude_files = &quot;Classes/**/*.h&quot;</span><br></pre></td></tr></table></figure></p>
<h4 id="2-提交HHYRep-podspec到官方Specs-Repo上"><a href="#2-提交HHYRep-podspec到官方Specs-Repo上" class="headerlink" title="2. 提交HHYRep.podspec到官方Specs Repo上"></a>2. 提交HHYRep.podspec到官方Specs Repo上</h4><p>添加我们的配置文件到官方的配置文件库中，将库进行关联方面后面我们进行查找。<br>首先我们需要验证我们的配置文件有没有通过验证<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> ~/Desktop/HHYRep   master ●  pod lib lint --allow-warnings</span><br><span class="line">HHYRep passed validation.</span><br></pre></td></tr></table></figure><br>这里我们加了—allow-warnings，为的是让警告也通过验证，不然过不了验证。这里出现passed validation.表示我们通过了验证，下面我们就可以提交文件到git官方仓库了<br>但之前我们需要查看是否有注册过Cocoapods账号。</p>
<h4 id="3-验证Cocoapods账号"><a href="#3-验证Cocoapods账号" class="headerlink" title="3. 验证Cocoapods账号"></a>3. 验证Cocoapods账号</h4><h6 id="1）终端输入pod-trunk-me"><a href="#1）终端输入pod-trunk-me" class="headerlink" title="1）终端输入pod trunk me"></a>1）终端输入<strong>pod trunk me</strong></h6><p>这里是还没有注册账号：</p>
<p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220519235133970.png" alt="查看是否注册Cocoapods邮箱.png"></p>
<h6 id="2）注册账号："><a href="#2）注册账号：" class="headerlink" title="2）注册账号："></a>2）注册账号：</h6><p>终端输入<strong>pod trunk me register 邮箱地址 ‘用户名’ —description=’描述信息’</strong></p>
<p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220519235134907.png" alt="注册Cocoapods账号.png"></p>
<h6 id="3）验证邮箱账号："><a href="#3）验证邮箱账号：" class="headerlink" title="3）验证邮箱账号："></a>3）验证邮箱账号：</h6><p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220519235135128.png" alt="验证Cocoapods账号.png"></p>
<h6 id="4）再次查看"><a href="#4）再次查看" class="headerlink" title="4）再次查看"></a>4）再次查看</h6><p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220519235135228.png" alt="Snip20181128_21.png"></p>
<p>这里显示我得账号信息以及我拥有的Pods</p>
<h4 id="4-上传HHYRep-podspec"><a href="#4-上传HHYRep-podspec" class="headerlink" title="4. 上传HHYRep.podspec"></a>4. 上传HHYRep.podspec</h4><p>终端输入<strong>pod trunk push HHYRep.podspec —allow-warnings</strong></p>
<p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220519235135452.png" alt="Snip20181128_22.png"></p>
<p>上传成功会出现如上页面。<br>到这，我们建立Cocoapods远程仓库就完成了。</p>
<p>我们可以用终端去搜索我们建的仓库<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> ~/Desktop/HHYRep   master ●  pod search HHYRep</span><br><span class="line">[!] Unable to find a pod with name, author, summary, or description matching `HHYRep`</span><br></pre></td></tr></table></figure><br>这里我们进行搜索的时候发现没搜索到，是因为有缓存，删掉就好了<br>终端输入<strong>rm ~/Library/Caches/CocoaPods/search_index.json</strong>，再次进行搜索，结构如下：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Common.h:12:78: warning: this block declaration is not a prototype [-Wstrict-pro</span><br><span class="line">-&gt; HHYRep (0.0.1)</span><br><span class="line">   HHYRep</span><br><span class="line">   pod &#x27;HHYRep&#x27;, &#x27;~&gt; 0.0.1&#x27;</span><br><span class="line">   - Homepage: https://github.com/HuiYouHua/HHYRep</span><br><span class="line">   - Source:   https://github.com/HuiYouHua/HHYRep.git</span><br><span class="line">   - Versions: 0.0.1 [master repo]</span><br><span class="line">   - Subspecs:</span><br><span class="line">     - HHYRep/TimerHelper (0.0.1)</span><br><span class="line">     - HHYRep/TimerHelper/GCD (0.0.1)</span><br><span class="line">     - HHYRep/TimerHelper/NSTimer (0.0.1)</span><br><span class="line">     - HHYRep/UITableVIewHelper (0.0.1)</span><br><span class="line">(END)</span><br></pre></td></tr></table></figure></p>
<h3 id="三、版本更新"><a href="#三、版本更新" class="headerlink" title="三、版本更新"></a>三、版本更新</h3><h3 id="1-修改-podspec文件中的版本号"><a href="#1-修改-podspec文件中的版本号" class="headerlink" title="1.修改.podspec文件中的版本号"></a>1.修改.podspec文件中的版本号</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 项目版本号</span><br><span class="line">s.version      = &quot;0.0.1&quot;</span><br></pre></td></tr></table></figure>
<h3 id="2-对项目进行更新"><a href="#2-对项目进行更新" class="headerlink" title="2. 对项目进行更新"></a>2. 对项目进行更新</h3><p>对项目进行代码的更改，同时也要<strong>pod install</strong>一下，更新工程到github上。</p>
<blockquote>
<h3 id="上传到github"><a href="#上传到github" class="headerlink" title="上传到github"></a>上传到github</h3><p>git add .<br>git commit -m -a<br>git push</p>
<h3 id="打tag值，跟版本号一致"><a href="#打tag值，跟版本号一致" class="headerlink" title="打tag值，跟版本号一致"></a>打tag值，跟版本号一致</h3><p>git tag ‘0.0.2’<br>git push —tags</p>
<h3 id="验证podspec文件并提交"><a href="#验证podspec文件并提交" class="headerlink" title="验证podspec文件并提交"></a>验证podspec文件并提交</h3><p>pod spec lint —allow-warnings<br>pod trunk push HHYRep.podspec —allow-warnings</p>
<h3 id="查找"><a href="#查找" class="headerlink" title="查找"></a>查找</h3><p>pod search HHYRep</p>
</blockquote>
<p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220519235135561.png" alt="Snip20181128_23.png"></p>
<h3 id="四、测试"><a href="#四、测试" class="headerlink" title="四、测试"></a>四、测试</h3><p>新建CocopodsDemo工程测试<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~/Desktop/CocopodsDemo  pod init</span><br><span class="line">~/Desktop/CocopodsDemo  touch podfile</span><br><span class="line">~/Desktop/CocopodsDemo  vi Podfile</span><br><span class="line">~/Desktop/CocopodsDemo  pod install</span><br></pre></td></tr></table></figure><br>新建文件podfile<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">platform:ios,&#x27;8.0&#x27;</span><br><span class="line">target &#x27;CocopodsDemo&#x27; do</span><br><span class="line">    </span><br><span class="line">    #source &#x27;https://github.com/CocoaPods/Specs.git&#x27;</span><br><span class="line">    #source &#x27;https://github.com/HuiYouHua/HHYPodspec.git&#x27;</span><br><span class="line">    </span><br><span class="line">pod &#x27;AFNetworking&#x27;, &#x27;~&gt;3.1.0&#x27; </span><br><span class="line">pod &#x27;HHYRep&#x27;, &#x27;~&gt; 0.0.2&#x27;</span><br><span class="line">end</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>文件目录</p>
<p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220519235137628.png" alt="Snip20181128_24.png"></p>
<p>其中显示有层级目录，写法可以参照<a target="_blank" rel="noopener" href="https://github.com/AFNetworking/AFNetworking/blob/master/AFNetworking.podspec">AFNetworking.podspec</a></p>
<h3 id="五、建立自己的Specs索引仓库"><a href="#五、建立自己的Specs索引仓库" class="headerlink" title="五、建立自己的Specs索引仓库"></a>五、建立自己的Specs索引仓库</h3><p>这种的也就是建立私有的远程仓库了<br>我们先了解下Specs和Specs Repo、Code和Code Repo。<br>github上把仓库都叫Repo，所以这四个分别对应的就是</p>
<blockquote>
<p>Specs：本地的索引仓库<br>Specs Repo：github官方的索引仓库<br>这两者存放的都是podsepc文件，里面记录了某个仓库的名称、描述、作者、版本、地址等等。索引仓库中每个项目都是以独立的文件夹的形式存放的，每个项目如果有不同的版本，那么不同的版本也会以独立的文件夹形式存放。</p>
<p>Code：本地的代码仓库<br>Code Repo：github上的代码仓库</p>
</blockquote>
<h4 id="1-建立索引仓库"><a href="#1-建立索引仓库" class="headerlink" title="1. 建立索引仓库"></a>1. 建立索引仓库</h4><p>进入github上创建索引仓库，创建方式跟创建代码仓库差不多。</p>
<p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220519235137899.png" alt="Snip20181128_25.png"></p>
<h4 id="2-将本地索引仓库和远程索引仓库关联"><a href="#2-将本地索引仓库和远程索引仓库关联" class="headerlink" title="2. 将本地索引仓库和远程索引仓库关联"></a>2. 将本地索引仓库和远程索引仓库关联</h4><h6 id="1）首先查看本机中存在索引仓库："><a href="#1）首先查看本机中存在索引仓库：" class="headerlink" title="1）首先查看本机中存在索引仓库："></a>1）首先查看本机中存在索引仓库：</h6><p>终端输入：<strong>pod repo</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> ~  pod repo</span><br><span class="line"></span><br><span class="line">master</span><br><span class="line">- Type: git (master)</span><br><span class="line">- URL:  https://github.com/CocoaPods/Specs.git</span><br><span class="line">- Path: /Users/huahuiyou/.cocoapods/repos/master</span><br><span class="line"></span><br><span class="line">1 repo</span><br></pre></td></tr></table></figure><br>这里展示的是本机中存在的索引仓库，其中master指的就是官方的索引仓库，我们在访达中进入~/.cocoapods/repos文件夹可以查看到。</p>
<h6 id="2-关联仓库"><a href="#2-关联仓库" class="headerlink" title="2.关联仓库"></a>2.关联仓库</h6><p>终端输入<strong>pod repo add 本机仓库名称 远程索引仓库地址</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> ~  pod repo add HHYSpecs https://github.com/HuiYouHua/HHYSpecs.git</span><br><span class="line">Cloning spec repo `HHYSpecs` from `https://github.com/HuiYouHua/HHYSpecs.git`</span><br><span class="line"> ~  pod repo</span><br><span class="line"></span><br><span class="line">HHYSpecs</span><br><span class="line">- Type: git (master)</span><br><span class="line">- URL:  https://github.com/HuiYouHua/HHYSpecs.git</span><br><span class="line">- Path: /Users/huahuiyou/.cocoapods/repos/HHYSpecs</span><br><span class="line"></span><br><span class="line">master</span><br><span class="line">- Type: git (master)</span><br><span class="line">- URL:  https://github.com/CocoaPods/Specs.git</span><br><span class="line">- Path: /Users/huahuiyou/.cocoapods/repos/master</span><br><span class="line"></span><br><span class="line">2 repos</span><br><span class="line"> ~ </span><br></pre></td></tr></table></figure><br>再次查看可以看到，多了一个自己命名的索引仓库</p>
<h6 id="3-将-podspec文件上传到索引仓库"><a href="#3-将-podspec文件上传到索引仓库" class="headerlink" title="3. 将.podspec文件上传到索引仓库"></a>3. 将.podspec文件上传到索引仓库</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Desktop/HHYRep   master  pod repo push HHYSpecs HHYRep.podspec --allow-warnings</span><br></pre></td></tr></table></figure>
<h6 id="4-查看索引仓库"><a href="#4-查看索引仓库" class="headerlink" title="4. 查看索引仓库"></a>4. 查看索引仓库</h6><p>远程索引仓库</p>
<p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220519235138541.png" alt="Snip20181128_26.png"></p>
<p>本机索引仓库</p>
<p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220520002132847.png" alt="Snip20181128_27.png"></p>
<ol>
<li>拉取仓库<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">platform:ios,&#x27;8.0&#x27;</span><br><span class="line">target &#x27;test&#x27; do</span><br><span class="line">    </span><br><span class="line">    # 官方的索引仓库，这里是用来引入AFNetworking的</span><br><span class="line">    source &#x27;https://github.com/CocoaPods/Specs.git&#x27;</span><br><span class="line">    # 自己的索引仓库，这里是引入HHYRep</span><br><span class="line">    source &#x27;https://github.com/HuiYouHua/HHYPodspec.git&#x27;</span><br><span class="line">    </span><br><span class="line">pod &#x27;AFNetworking&#x27;, &#x27;~&gt;3.1.0&#x27; </span><br><span class="line">pod &#x27;HHYRep&#x27;, &#x27;~&gt; 0.0.6&#x27;</span><br><span class="line">end</span><br><span class="line"></span><br></pre></td></tr></table></figure>
另外当官方索引仓库和私有仓库都有索引的话，会出现冲突，所以删掉一个或者指明引用对象即可。</li>
</ol>
<p>综上就是Cocoapods的共有仓库和私有仓库的搭建。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/11/30/%E6%94%AF%E4%BB%98%E5%AE%9D%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/android-chrome-384x384.png">
      <meta itemprop="name" content="HuiYou Hua">
      <meta itemprop="description" content="iOS 开发相关日常总结记录。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuiYouHua">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/11/30/%E6%94%AF%E4%BB%98%E5%AE%9D%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">支付宝使用总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-11-30 00:01:53" itemprop="dateCreated datePublished" datetime="2016-11-30T00:01:53+08:00">2016-11-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%94%AF%E4%BB%98/" itemprop="url" rel="index"><span itemprop="name">支付</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><blockquote>
<p>写这篇文章主要是总结一下支付宝的使用,因为最近这个项目要添加一个支付宝功能,所有的资料都是通过查看蚂蚁金服开发者平台和其他开发者写的一些资料加上自己的汇总得来的</p>
<p>但是呢,不幸的是这个项目不能采用第三方支付,因为购买的是虚拟产品,更新审核很大可能不会给过,有人说可以通过控制后台开关进行控制前台支付功能的隐藏,过了审核再打开开关,但是风险还是比较大的,被发现了那就GG</p>
<p>这个项目采用的是内购,支付宝呢我自己研究下,这里就总结一下以后有机会的话我再尝试了,大差不差</p>
<p>好了,废话不多说了,开始进入正题</p>
</blockquote>
<h2 id="一、准备工作"><a href="#一、准备工作" class="headerlink" title="一、准备工作"></a>一、准备工作</h2><p>需要的东西:</p>
<ul>
<li>商户唯一的PID(partner的简称):是商户与支付宝签约后,商户获得的支付宝商户唯一标识码.当商户把支付宝功能介入商户网站时会PID,以便让支付宝认证商户.</li>
<li>账号ID(sellerID):用户购买的支付账号,订单支付金额将打入该账户,一个partner可以对应多个seller_id。</li>
<li>下载相应的公钥私钥(加密签名使用,RSA加密)<br>其中前两个一般都是公司负责的,但是非要你弄的的话也没事:</li>
</ul>
<p>1.首先你需要有一个支付宝账号(最好公司的)登录<a target="_blank" rel="noopener" href="https://open.alipay.com/platform/home.htm">蚂蚁金服</a>实名认证这个支付宝账号,需要视同企业资料,成为企业支付宝账号.<br>2.登录支付宝官方网站<a target="_blank" rel="noopener" href="https://b.alipay.com/order/serviceIndex.htm">支付宝商家中心</a>,与支付宝进行签约.<br>3.然后进入开发者平台,创建应用,<a target="_blank" rel="noopener" href="https://doc.open.alipay.com/doc2/detail.htm?spm=a219a.7629140.0.0.mLiPMe&amp;treeId=197&amp;articleId=105240&amp;docType=1#s0">官方文档</a><br>4.按照官方文档走,生成公钥和私钥以及上述的几个东西</p>
<p>注:其中RSA密钥私钥有两个,一个是pkcs8密钥和普通密钥,这里我们使用pkcs8密钥,另外公钥是用来在开发平台的应用配置中添加公钥,同时会生成一个支付宝公钥.</p>
<h2 id="二、集成支付宝SDK"><a href="#二、集成支付宝SDK" class="headerlink" title="二、集成支付宝SDK"></a>二、集成支付宝SDK</h2><p>1.支付宝SDK下载地址为:<a target="_blank" rel="noopener" href="https://doc.open.alipay.com/doc2/detail.htm?treeId=54&amp;articleId=104509&amp;docType=1">这里</a><br>PS:另外还可以下载对应服务端SDK,各种不同的开发语言都有集成示例.</p>
<p>2.来看看我们的SDK里需要的东西:</p>
<p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220519234930613.png" alt="支付宝SDK内的玩意.png"><br>我们需要的东西如下:</p>
<p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220519234930663.png" alt="需要的东西.png"><br>将这几个文件放到一个文件夹中并命名为AliPaySDK拖入项目中.</p>
<p>3.下面就是环境的配置了,这个东西网上找找,相信你可以配置成功的,就不多说了,给你两个地址好了:<br><a target="_blank" rel="noopener" href="https://doc.open.alipay.com/doc2/detail.htm?treeId=204&amp;articleId=105295&amp;docType=1">官方文档环境配置</a><br><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/2aedc82c02b5">民间高手配置</a><br>出了什么问题,结合这两个就可以了.</p>
<h2 id="三、支付宝支付流程"><a href="#三、支付宝支付流程" class="headerlink" title="三、支付宝支付流程"></a>三、支付宝支付流程</h2><p>这里是借鉴别人的支付流程了,<a target="_blank" rel="noopener" href="http://www.jianshu.com/p/11af0e29a6a7">你看</a></p>
<p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220519234930733.png" alt="支付流程.png"><br>支付过程:<br>1.用户向商城网站发起确认订单的请求<br>2.商城网站接收到请求保存订单数据到数据库或其他存储介质<br>3.返回订单确认页面,页面上应该显示订单金额等信息<br>4.用户确认支付,发起支付请求.注:支付请求时发送到支付网关(比如支付宝,网银在线等)而不是发送到商城网站<br>5.显示支付页面<br>6.用户填写认证信息(账号密码等)提交<br>7.这里有两个步骤,一个是扣款成功后页面跳转到支付结果页面(展示给用户),另一个是支付通知,这两步没有先后顺序可能同时执行,商城网站接收到支付通知后根据验证规则验证信息的有效性,并作出相应的更改操作(例:有效则更改订单为已付款装填,无效则记录非法请求信息).</p>
<p>那么我们注意的就是第4步和第7步</p>
<h2 id="四、客户端代码的实现"><a href="#四、客户端代码的实现" class="headerlink" title="四、客户端代码的实现"></a>四、客户端代码的实现</h2><h5 id="入口类"><a href="#入口类" class="headerlink" title="入口类"></a>入口类</h5><p>支付宝客户端打开<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)application:(UIApplication *)application</span><br><span class="line">            openURL:(NSURL *)url</span><br><span class="line">  sourceApplication:(NSString *)sourceApplication</span><br><span class="line">         annotation:(id)annotation &#123;</span><br><span class="line">    </span><br><span class="line">    if ([url.host isEqualToString:@&quot;safepay&quot;]) &#123;</span><br><span class="line">        //跳转支付宝钱包进行支付，处理支付结果</span><br><span class="line">        [[AlipaySDK defaultService] processOrderWithPaymentResult:url standbyCallback:^(NSDictionary *resultDic) &#123;</span><br><span class="line">            NSLog(@&quot;result = %@&quot;,resultDic);</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">    return YES;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// NOTE: 9.0以后使用新API接口</span><br><span class="line">- (BOOL)application:(UIApplication *)app openURL:(NSURL *)url options:(NSDictionary *)options</span><br><span class="line">&#123;</span><br><span class="line">    if ([url.host isEqualToString:@&quot;safepay&quot;]) &#123;</span><br><span class="line">        //跳转支付宝钱包进行支付，处理支付结果</span><br><span class="line">        [[AlipaySDK defaultService] processOrderWithPaymentResult:url standbyCallback:^(NSDictionary *resultDic) &#123;</span><br><span class="line">            NSLog(@&quot;result = %@&quot;,resultDic);</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">    return YES;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="生成订单信息"><a href="#生成订单信息" class="headerlink" title="生成订单信息"></a>生成订单信息</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">    *商户的唯一的parnter和seller。</span><br><span class="line">    *签约后，支付宝会为每个商户分配一个唯一的 parnter 和 seller。</span><br><span class="line">    */</span><br><span class="line"> /*============================================================================*/</span><br><span class="line">   /*=======================需要填写商户app申请的===================================*/</span><br><span class="line">   /*============================================================================*/</span><br><span class="line">   NSString *partner = PID;</span><br><span class="line">   NSString *seller = @&quot;&quot;;</span><br><span class="line">   NSString *privateKey = kPrivateKey;</span><br><span class="line">   //支付宝公钥（目前所有支付宝公钥都是这个）</span><br><span class="line">   NSString* key = @&quot;&quot;;</span><br><span class="line">   //这个方法应该是初始化公钥并保存到本地吧</span><br><span class="line">   id&lt;DataVerifier&gt; verifier = CreateRSADataVerifier(key);</span><br><span class="line">   /*============================================================================*/</span><br><span class="line">   /*============================================================================*/</span><br><span class="line">   /*============================================================================*/</span><br><span class="line">   </span><br><span class="line">   //partner和seller获取失败,提示</span><br><span class="line">   if ([partner length] == 0 ||</span><br><span class="line">       [seller length] == 0 ||</span><br><span class="line">       [privateKey length] == 0)</span><br><span class="line">   &#123;</span><br><span class="line">       UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@&quot;提示&quot;</span><br><span class="line">                                                       message:@&quot;缺少partner或者seller或者私钥。&quot;</span><br><span class="line">                                                      delegate:self</span><br><span class="line">                                             cancelButtonTitle:@&quot;确定&quot;</span><br><span class="line">                                             otherButtonTitles:nil];</span><br><span class="line">       [alert show];</span><br><span class="line">       return;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   /*</span><br><span class="line">    *生成订单信息及签名</span><br><span class="line">    */</span><br><span class="line">   //将商品信息赋予AlixPayOrder的成员变量</span><br><span class="line">   Order *order = [[Order alloc] init];</span><br><span class="line">   order.partner = partner;</span><br><span class="line">   order.sellerID = seller;</span><br><span class="line">   order.outTradeNO = @&quot;10087&quot;; //订单ID（由商家自行制定）</span><br><span class="line">   order.subject = @&quot;火车票&quot;; //商品标题</span><br><span class="line">   order.body = @&quot;这是从北京到芜湖的火车票&quot;; //商品描述</span><br><span class="line">   order.totalFee = @&quot;0.01&quot;; //商品价格</span><br><span class="line">   order.notifyURL =  @&quot;http://www.baidu.com&quot;; //回调URL</span><br><span class="line">   </span><br><span class="line">   order.service = @&quot;mobile.securitypay.pay&quot;;</span><br><span class="line">   order.paymentType = @&quot;1&quot;;</span><br><span class="line">   order.inputCharset = @&quot;utf-8&quot;;</span><br><span class="line">   order.itBPay = @&quot;30m&quot;;</span><br><span class="line">   order.showURL = @&quot;m.alipay.com&quot;;</span><br></pre></td></tr></table></figure>
<h5 id="应用注册scheme-在AlixPayDemo-Info-plist定义URL-types"><a href="#应用注册scheme-在AlixPayDemo-Info-plist定义URL-types" class="headerlink" title="应用注册scheme,在AlixPayDemo-Info.plist定义URL types"></a>应用注册scheme,在AlixPayDemo-Info.plist定义URL types</h5><p>注意这一步<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NSString *appScheme = @&quot;alisdkdemo&quot;;</span><br></pre></td></tr></table></figure></p>
<h5 id="将商品拼接成字符串"><a href="#将商品拼接成字符串" class="headerlink" title="将商品拼接成字符串"></a>将商品拼接成字符串</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//将商品信息拼接成字符串</span><br><span class="line">NSString *orderSpec = [order description];</span><br><span class="line">NSLog(@&quot;orderSpec = %@&quot;,orderSpec);</span><br><span class="line"></span><br><span class="line">//获取私钥并将商户信息签名,外部商户可以根据情况存放私钥和签名,只需要遵循RSA签名规范,并将签名字符串base64编码和UrlEncode</span><br><span class="line">id&lt;DataSigner&gt; signer = CreateRSADataSigner(privateKey);</span><br><span class="line">NSString *signedString = [signer signString:orderSpec];</span><br><span class="line"></span><br><span class="line">//将签名成功字符串格式化为订单字符串,请严格按照该格式</span><br><span class="line">NSString *orderString = nil;</span><br><span class="line">if (signedString != nil) &#123;</span><br><span class="line">    orderString = [NSString stringWithFormat:@&quot;%@&amp;sign=\&quot;%@\&quot;&amp;sign_type=\&quot;%@\&quot;&quot;,</span><br><span class="line">                   orderSpec, signedString, @&quot;RSA&quot;];</span><br><span class="line">    </span><br><span class="line">    [[AlipaySDK defaultService] payOrder:orderString fromScheme:appScheme callback:^(NSDictionary *resultDic) &#123;</span><br><span class="line">        NSLog(@&quot;返回结果resultDic = %@&quot;,resultDic);</span><br></pre></td></tr></table></figure>
<h5 id="支付结果页面验证"><a href="#支付结果页面验证" class="headerlink" title="支付结果页面验证"></a>支付结果页面验证</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">            if (resultDic)</span><br><span class="line">            &#123;</span><br><span class="line">                /*</span><br><span class="line">                 9000 订单支付成功</span><br><span class="line">                 8000 正在处理中</span><br><span class="line">                 4000 订单支付失败</span><br><span class="line">                 6001 用户中途取消</span><br><span class="line">                 6002 网络连接出错</span><br><span class="line">                 */</span><br><span class="line">                if ([resultDic[@&quot;resultStatus&quot;]integerValue] == 9000)</span><br><span class="line">                    //网上很多教程到这里就结束了，因为他们没有验证返回订单签名</span><br><span class="line">                &#123;</span><br><span class="line">                    //验签</span><br><span class="line">                    //去掉返回字典中result值里面的“\\”</span><br><span class="line">                    NSString *result = [resultDic[@&quot;result&quot;] stringByReplacingOccurrencesOfString:@&quot;\\\\&quot; withString:@&quot;&quot;];</span><br><span class="line">                    //分割字符串获取订单信息和签名</span><br><span class="line">//                     [self.result componentsSeparatedByString:@&quot;&amp;sign_type=\&quot;RSA\&quot;&amp;sign=&quot;][0];</span><br><span class="line">                    NSArray *array = [result componentsSeparatedByString:@&quot;&amp;sign_type=\&quot;RSA\&quot;&amp;sign=&quot;];</span><br><span class="line">                      //返回的订单信息</span><br><span class="line">                      NSString *orderString = array[0];</span><br><span class="line">                      //返回的订单签名</span><br><span class="line">                      NSString *signedString = [array[1] substringToIndex:[array[1]length]-1];</span><br><span class="line">                      //验证返回信息与签名</span><br><span class="line">                      if ([verifier verifyString:orderString withSign:signedString])</span><br><span class="line">                      &#123;</span><br><span class="line">                          //验证签名成功，交易结果无篡改</span><br><span class="line">                          NSLog(@&quot;------------支付成功---------------&quot;);</span><br><span class="line">                      &#125;</span><br><span class="line">                      else</span><br><span class="line">                      &#123;</span><br><span class="line">                          //验签错误</span><br><span class="line">                      &#125;</span><br><span class="line">                      </span><br><span class="line">                      &#125;</span><br><span class="line">                      </span><br><span class="line">                      &#125;</span><br><span class="line">                      else</span><br><span class="line">                      &#123;</span><br><span class="line">                          //交易失败</span><br><span class="line">                      &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里实现由上述步骤中的第4步以及第7步中的支付结果页面(这个是展示给用户的)<br><strong>注意:关于第4步的密钥加签和第7步的验证最好放到服务器端做,以保证安全</strong></p>
<p>这个是支付请求接口的callback返回的resultDic,摆出来方便研究<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">po resultDic</span><br><span class="line">&#123;</span><br><span class="line">    memo = “&quot;;</span><br><span class="line">    result = &quot;partner=\&quot;2088121307144063\&quot;&amp;seller_id=\&quot;service@9elephas.com\&quot;&amp;out_trade_no=\&quot;10086\&quot;&amp;subject=\&quot;\U706b\U8f66\U7968\&quot;&amp;body=\&quot;\U8fd9\U662f\U4ece\U5317\U4eac\U5230\U829c\U6e56\U7684\U706b\U8f66\U7968\&quot;&amp;total_fee=\&quot;0.01\&quot;&amp;notify_url=\&quot;http://www.baidu.com\&quot;&amp;service=\&quot;mobile.securitypay.pay\&quot;&amp;payment_type=\&quot;1\&quot;&amp;_input_charset=\&quot;utf-8\&quot;&amp;it_b_pay=\&quot;30m\&quot;&amp;show_url=\&quot;m.alipay.com\&quot;&amp;success=\&quot;true\&quot;&amp;sign_type=\&quot;RSA\&quot;&amp;sign=\&quot;Qtqv2CjSf2WXdg37cLKiN0b+nCdJsAk+deB95c+qykyz1F9Zc2sglc+6/tReTNoIFbX4D3jS31KMYEuDHuwx8ibm8fyDYpAPxHsD1x6+MaoBpXAe2UtsF6v7xFGzhmieJ8hG4WYgUhxp6LrxtSBHuxreI+pjMSeaMA0qZEvJj4g=\&quot;&quot;;</span><br><span class="line">    resultStatus = 9000;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="五、接口问题"><a href="#五、接口问题" class="headerlink" title="五、接口问题"></a>五、接口问题</h2><p>这里讲述的东西还是上面所说的第4步和第7步<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 支付宝SDK支付请求接口</span><br><span class="line">- (void)payOrder:(NSString *)orderStr</span><br><span class="line">      fromScheme:(NSString *)schemeStr</span><br><span class="line">        callback:(CompletionBlock)completionBlock;</span><br></pre></td></tr></table></figure><br>这个方法是用来发送支付请求,也就是第4步中的确认支付(发起支付请求)<br>另外还有一个方法<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- (void)processOrderWithPaymentResult:(NSURL *)resultUrl</span><br><span class="line">                      standbyCallback:(CompletionBlock)completionBlock;</span><br></pre></td></tr></table></figure><br>  这两方法的区别之处主要是区分你的手机有没有下载支付宝客户端,如果没有下载支付宝客户端,在你支付完成后,支付宝服务器会通过callback返回信息,反之会在standbyCallback返回信息.</p>
<p>在上面的代码中可以看到,我们在返回信息的block中做了验签操作,当然这个最好是放在服务器端进行.我们除了在这里做验签操作之外,我们还需要做些可视化的操作,比如说通知用户这笔交易的成功与否,需要给用户展示什么样的东西等等…(注意,我们这里还没有对服务器数据库等做更新订单的操作)</p>
<p>同时当我们阅读<a target="_blank" rel="noopener" href="https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.A8CMxI&amp;treeId=193&amp;articleId=105302&amp;docType=1">开放平台文档</a>的时候会发现他有两种通知,一种是客户端同步返回,一种是支付结果异步通知,其主要区别如下:<br>其官方文档是这样说的:</p>
<blockquote>
<p>支付宝SDK对商户的请求支付(payOrder方法)数据处理完成后,会将结果同步反馈给商户app端.<br><strong>同步返回的数据，商户可以按照下文描述的方式在服务端<br>验证，验证通过后，可以认为本次用户付款成功。有些时候会出现商户app在支付宝付款阶段被关闭导致无法正确收到同步结果，此时支付结果可以完全依赖服务端的异步通知。</strong><br><strong>由于同步通知和异步通知都可以作为支付完成的凭证，且异步通知支付宝一定会确保发送给商户服务端。为了简化集成流程，商户可以将同步结果仅仅作为一个支付结束的通知（忽略执行校验），实际支付是否成功，完全依赖服务端异步通知。
</strong></p>
</blockquote>
<p>这里我来解释下,意思就是说当你支付完成后,支付宝页面会自动跳转到之前的界面,但是会有这样的情况发生,就是当你界面还没跳转时,用户自己将该页面关闭,那就无法正确的收到同步结果了,因此这里还必须得采用服务器端异步通知来保持订单的同步.</p>
<p>至于同步操作就不多说了,在这里我们主要做两件事,一件就是验签,保证订单的可靠性,另外就是一些可视化操作,让用户知道交易成功与否.<br>这里是官方文档对于客户端同步返回的介绍:</p>
<blockquote>
<p><strong>第四步：</strong> 验证签名是否合法：<br>使用各自语言对应的SHA1WithRSA签名验证函数，传入签名的原始字符串、支付宝公钥、签名类型RSA、签名字符进行合法性验证。<br><strong>第五步： 在第四步签名验证通过后，必须严格按照如下的描述校验通知参数的合法性：</strong><br><strong>1、商户需要验证该通知数据中的out_trade_no是否为商户系统中创建的订单号；2、判断total_amount是否确实为该订单的实际金额（即商户订单创建时的金额）；3、校验通知中的seller_id（或者seller_email) 是否为out_trade_no这笔单据对应的操作方（有的时候，一个商户可能有多个seller_id/seller_email）；4、验证app_id是否为该商户本身。上述1、2、3、4有任何一个验证不通过，则表明同步校验结果是无效的，只有全部验证通过后，才可以认定买家付款成功。</strong></p>
</blockquote>
<h2 id="六、支付结果异步通知"><a href="#六、支付结果异步通知" class="headerlink" title="六、支付结果异步通知"></a>六、支付结果异步通知</h2><blockquote>
<p>看官方文档中的介绍:<strong>对于App支付产生的交易，支付宝会根据原始支付API中传入的异步通知地址notify_url，通过POST请求的形式将支付结果作为参数通知到商户系统。</strong></p>
</blockquote>
<p>这里的异步通知地址就是之前构建订单信息中的回调地址notify_url</p>
<p>再看,服务器异步通知页面特性:</p>
<blockquote>
<p>必须保证服务器异步通知页面（notify_url）上无任何字符，如空格、HTML标签、开发系统自带抛出的异常提示信息等；</p>
<p>支付宝是用POST方式发送通知信息，因此该页面中获取参数的方式，如：request.Form(“out_trade_no”)、$_POST[‘out_trade_no’]；</p>
<p>支付宝主动发起通知，该方式才会被启用；</p>
<p>只有在支付宝的交易管理中存在该笔交易，且发生了交易状态的改变，支付宝才会通过该方式发起服务器通知（即时到账交易状态为“等待买家付款”的状态默认是不会发送通知的）；</p>
<p>服务器间的交互，不像页面跳转同步通知可以在页面上显示出来，这种交互方式是不可见的；</p>
<p>第一次交易状态改变（即时到账中此时交易状态是交易完成）时，不仅会返回同步处理结果，而且服务器异步通知页面也会收到支付宝发来的处理结果通知；</p>
<p>程序执行完后必须打印输出“success”（不包含引号）。如果商户反馈给支付宝的字符不是success这7个字符，支付宝服务器会不断重发通知，直到超过24小时22分钟。一般情况下，25小时以内完成8次通知（通知的间隔频率一般是：4m,10m,10m,1h,2h,6h,15h）；</p>
<p>程序执行完成后，该页面不能执行页面跳转。如果执行页面跳转，支付宝会收不到success字符，会被支付宝服务器判定为该页面程序运行出现异常，而重发处理结果通知；</p>
<p>cookies、session等在此页面会失效，即无法获取这些数据；</p>
<p>该方式的调试与运行必须在服务器上，即互联网上能访问；<br>该方式的作用主要防止订单丢失，即页面跳转同步通知没有处理订单更新，它则去处理；</p>
<p>当商户收到服务器异步通知并打印出success时，服务器异步通知参数notify_id才会失效。也就是说在支付宝发送同一条异步通知时（包含商户并未成功打印出success导致支付宝重发数次通知），服务器异步通知参数notify_id是不变的。</p>
</blockquote>
<p>这里需要注意的是:<br>他是当订单状态发生变化时,支付宝服务器才会通知这个页面,然后在这个页面做验签,更新服务器数据库等操作.<br>另外验签通过后需要返回success,不然会重复通知.</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这里总结一下,支付宝这一块最重要的应该就是上面说的确认支付和返回结果页面以及支付通知信息这一块,搞定了就不难了,当然还有RSA算法,有时间我去研究研究,这个不是重点</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/08/22/XMPP/(%E5%8D%81%E5%9B%9B)%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E4%B9%8BXMPPFramework%E6%9C%AC%E5%9C%B0%E9%80%9A%E7%9F%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/android-chrome-384x384.png">
      <meta itemprop="name" content="HuiYou Hua">
      <meta itemprop="description" content="iOS 开发相关日常总结记录。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuiYouHua">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/08/22/XMPP/(%E5%8D%81%E5%9B%9B)%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E4%B9%8BXMPPFramework%E6%9C%AC%E5%9C%B0%E9%80%9A%E7%9F%A5/" class="post-title-link" itemprop="url">(十四)即时通讯之XMPPFramework本地通知</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-08-22 00:04:53" itemprop="dateCreated datePublished" datetime="2016-08-22T00:04:53+08:00">2016-08-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/XMPP/" itemprop="url" rel="index"><span itemprop="name">XMPP</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><blockquote>
<p>这也是本人第一次琢磨关于即时通讯方面的内容,结合网上查看的相关资料搭建出来的仿微信小demo,如有意见请多多指教</p>
</blockquote>
<p><strong>具体项目可以在github<a target="_blank" rel="noopener" href="https://git.oschina.net/huyoyu/WeiChat">WeiChat</a>下载进行查看,如若各位看官老爷觉得还可以请点star</strong></p>
<p>续前篇<a target="_blank" rel="noopener" href="http://www.jianshu.com/p/6b3c12790f8e">(十)即时通讯之XMPPFramework登陆注册</a></p>
<p>续前篇<a target="_blank" rel="noopener" href="http://www.jianshu.com/p/b1be451ccf5c">(十一)即时通讯之XMPPFramework电子名片</a></p>
<p>续前篇<a target="_blank" rel="noopener" href="http://www.jianshu.com/p/e542856d24a9">(十二)即时通讯之XMPPFramework花名册</a></p>
<p>续前篇<a target="_blank" rel="noopener" href="http://www.jianshu.com/p/1a6b01217778">(十三)即时通讯之XMPPFramework文字语音图片聊天</a></p>
<p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220520002024874.png" alt="服务器地址"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">**Attention,这里需要改成自己的服务器地址和端口号</span><br><span class="line">并且数据库和服务器一定要开启哟,不然没法登陆的哟**</span><br><span class="line">#ifdef DEBUG</span><br><span class="line">#define kHostName @&quot;192.168.199.111&quot;</span><br><span class="line">//#define kHostName @&quot;127.0.0.1&quot;</span><br><span class="line">#define kHostPort 5222</span><br><span class="line">#else</span><br><span class="line">#define kHostNanme @&quot;&quot;</span><br><span class="line">#define kHostPort 5222</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<h2 id="本地通知"><a href="#本地通知" class="headerlink" title="本地通知"></a>本地通知</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">**本地通知**</span><br><span class="line">****</span><br><span class="line">**入口方法中调用以下代码**</span><br><span class="line">- (void)registerPush&#123;</span><br><span class="line">    float sysVer = [[[UIDevice currentDevice] systemVersion] floatValue];</span><br><span class="line">    if(sysVer &lt; 8)&#123;</span><br><span class="line">        [[UIApplication sharedApplication] registerForRemoteNotificationTypes:(UIRemoteNotificationTypeAlert | UIRemoteNotificationTypeBadge | UIRemoteNotificationTypeSound)];</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">#if __IPHONE_OS_VERSION_MAX_ALLOWED &gt;= _IPHONE80_</span><br><span class="line">        UIMutableUserNotificationCategory *categorys = [[UIMutableUserNotificationCategory alloc] init];</span><br><span class="line">        UIUserNotificationSettings *userSettings = [UIUserNotificationSettings settingsForTypes:UIUserNotificationTypeBadge|UIUserNotificationTypeSound|UIUserNotificationTypeAlert</span><br><span class="line">                                                                                     categories:[NSSet setWithObject:categorys]];</span><br><span class="line">        [[UIApplication sharedApplication] registerUserNotificationSettings:userSettings];</span><br><span class="line">        [[UIApplication sharedApplication] registerForRemoteNotifications];</span><br><span class="line">#endif</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">****</span><br><span class="line">**添加plist选项**</span><br><span class="line">打开后台模式,添加一个Voice over IP</span><br><span class="line">****</span><br><span class="line">**允许XMPPStream的Socket后台运行**</span><br><span class="line">_xmppStream.enableBackgroundingOnSocket = YES;</span><br><span class="line">****</span><br><span class="line">**XMPPManaget中添加一个代理方法**</span><br><span class="line">- (void)xmppStream:(XMPPStream *)sender didReceiveMessage:(XMPPMessage *)message &#123;</span><br><span class="line">    NSLog(@&quot;收到消息&quot;);</span><br><span class="line">    if ([UIApplication sharedApplication].applicationState != UIApplicationStateActive) &#123;</span><br><span class="line">        NSLog(@&quot;我在后台收到消息&quot;);</span><br><span class="line">        [UIApplication sharedApplication].applicationIconBadgeNumber = 5;</span><br><span class="line">        // 本地通知</span><br><span class="line">        UILocalNotification *localNote = [[UILocalNotification alloc] init];</span><br><span class="line">        // 设置通知内容</span><br><span class="line">        localNote.alertBody = [NSString stringWithFormat:@&quot;%@\n%@&quot;,message.fromStr,message.body];</span><br><span class="line">        // 设置时间</span><br><span class="line">        localNote.fireDate = [NSDate date];</span><br><span class="line">        // 设置声音</span><br><span class="line">        localNote.soundName = @&quot;default&quot;;</span><br><span class="line">        // 执行</span><br><span class="line">        [[UIApplication sharedApplication] scheduleLocalNotification:localNote];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // 什么也不做</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/08/22/XMPP/(%E5%8D%81%E4%B8%89)%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E4%B9%8BXMPPFramework%E6%96%87%E5%AD%97%E8%AF%AD%E9%9F%B3%E5%9B%BE%E7%89%87%E8%81%8A%E5%A4%A9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/android-chrome-384x384.png">
      <meta itemprop="name" content="HuiYou Hua">
      <meta itemprop="description" content="iOS 开发相关日常总结记录。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuiYouHua">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/08/22/XMPP/(%E5%8D%81%E4%B8%89)%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E4%B9%8BXMPPFramework%E6%96%87%E5%AD%97%E8%AF%AD%E9%9F%B3%E5%9B%BE%E7%89%87%E8%81%8A%E5%A4%A9/" class="post-title-link" itemprop="url">(十三)即时通讯之XMPPFramework文字语音图片聊天</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-08-22 00:03:53" itemprop="dateCreated datePublished" datetime="2016-08-22T00:03:53+08:00">2016-08-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/XMPP/" itemprop="url" rel="index"><span itemprop="name">XMPP</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><blockquote>
<p>这也是本人第一次琢磨关于即时通讯方面的内容,结合网上查看的相关资料搭建出来的仿微信小demo,如有意见请多多指教</p>
</blockquote>
<p><strong>具体项目可以在github<a target="_blank" rel="noopener" href="https://git.oschina.net/huyoyu/WeiChat">WeiChat</a>下载进行查看,如若各位看官老爷觉得还可以请点star</strong></p>
<p>续前篇<a target="_blank" rel="noopener" href="http://www.jianshu.com/p/6b3c12790f8e">(十)即时通讯之XMPPFramework登陆注册</a></p>
<p>续前篇<a target="_blank" rel="noopener" href="http://www.jianshu.com/p/b1be451ccf5c">(十一)即时通讯之XMPPFramework电子名片</a></p>
<p>续前篇<a target="_blank" rel="noopener" href="http://www.jianshu.com/p/e542856d24a9">(十二)即时通讯之XMPPFramework花名册</a></p>
<p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220519235557364.png" alt="服务器地址"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">**Attention,这里需要改成自己的服务器地址和端口号</span><br><span class="line">并且数据库和服务器一定要开启哟,不然没法登陆的哟**</span><br><span class="line">#ifdef DEBUG</span><br><span class="line">#define kHostName @&quot;192.168.199.111&quot;</span><br><span class="line">//#define kHostName @&quot;127.0.0.1&quot;</span><br><span class="line">#define kHostPort 5222</span><br><span class="line">#else</span><br><span class="line">#define kHostNanme @&quot;&quot;</span><br><span class="line">#define kHostPort 5222</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<p>先来谈谈做聊天功能的感想,其实吧,这个也不复杂,主要是界面搭建过于麻烦,先来说<strong>功能实现:</strong></p>
<blockquote>
<p>1.关于聊天功能,当日这个包括有文字,语音,图片,还有文件传输,视频音频聊天,这些我就没写了,就实现了文字,语音,图片这三个部分,后面的再写也没多大意思了.<br>2.其实关于聊天说到底就一个方法sendElement:(NSXMLElement *)element,后面跟上你要发送的内容就行了.<br>3.既然有各种不同的聊天内容,那就要加上关键字进行判断来区分是文字是语音还是图片.<br>4.这区分不同内容也有好几种方式<br>5.对于发送内容有两种方式,当日是对于语音图片,这种大容量的内容来说的,第一种是使用XML来携带内容,这种方式对服务器压力很大,因为一旦携带的内容过大,那么就会使传输速度变得很慢.另一种是通过文件服务器的方式,通过put将要传输方式发送到文件服务器,然后发送URL就可以了,对于文件的传输与接收都是通过上传下载来完成.这两种方式都有实现,可以看demo.<br>6.聊天功能最重要的就是你要知道你传输的message的结构是什么样的,由于是用XML组织的,所以很容易就能知道你传输的内容组织,这样能方便你进行区分传输内容以及扩展你想要的一些功能,还要做一些回执操作,以及类似心跳包之类的操作.</p>
</blockquote>
<p>再来说说<strong>界面实现:</strong></p>
<blockquote>
<p>1.首先重中之重是得选择一个好的设计模式了,这里采用MVVM,将原先的数据模型分为数据模型加frame模型,其业务逻辑分开,在获取数据时,就对数据和frame进行计算,再在单元格初始化的时候进行赋值.<br>2.其次是frame的计算,因为有文字,图片,语音所以得慢慢计算单元格的自适应高度.<br>3.对于键盘的处理,这个其实蛮复杂的,尤其是点击发文件按钮后,弹出的一个自定义模块,这个你们看demo吧,不过多阐述了,这里主要讲的是功能实现,界面实现就发挥你们的想象力好了.<br>4.另外还有对于界面处理的诸多细节,demo中也有部分未处理好,万望谅解.</p>
</blockquote>
<p>看图:<br>这里高度有点不对,但是并没找到原因<br><strong>注意,这里需要模拟器和真机进行测试,展示给读者的是模拟器,真机就没有展示出来了</strong><br><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/strip-20220519235615975.gif" alt="文字聊天.gif"></p>
<p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/strip-20220519235625563.gif" alt="图片聊天.gif"></p>
<p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/strip-20220519235633223.gif" alt="语音聊天"></p>
<blockquote>
<p>丑话说在中间,聊天界面还存在有一个bug,暂且还没找出来为什么,但不影响使用</p>
</blockquote>
<p>本篇讲的是聊天功能中的聊天功能的实现,内容有点长,请耐心观看.</p>
<h3 id="1-聊天模块激活"><a href="#1-聊天模块激活" class="headerlink" title="1.聊天模块激活"></a>1.聊天模块激活</h3><p>没什么好说的,跟前面的一样,聊天模块激活<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> *  XMPPMessageArchiving聊天模块激活</span><br><span class="line"> */</span><br><span class="line">self.archivingStorage = [XMPPMessageArchivingCoreDataStorage sharedInstance];</span><br><span class="line">self.messageArchiving = [[XMPPMessageArchiving alloc] initWithMessageArchivingStorage:self.archivingStorage dispatchQueue:dispatch_get_main_queue()];</span><br><span class="line">[self.messageArchiving activate:self.stream];</span><br></pre></td></tr></table></figure></p>
<h3 id="2-发送文字聊天内容"><a href="#2-发送文字聊天内容" class="headerlink" title="2.发送文字聊天内容"></a>2.发送文字聊天内容</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#pragma mark - TextView的代理方法 点击renturn发送信息</span><br><span class="line">#pragma mark 发送文字聊天信息</span><br><span class="line">- (void)textViewDidChange:(UITextView *)textView &#123;</span><br><span class="line">    if ([textView.text hasSuffix:@&quot;\n&quot;]) &#123;</span><br><span class="line">        NSLog(@&quot;已经发送消息&quot;);</span><br><span class="line">        [self sendMessageWithText:textView.text bodyType:@&quot;text&quot;];</span><br><span class="line">        textView.text = nil;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)sendMessageWithText:(NSString *)text bodyType:(NSString *)type &#123;</span><br><span class="line">//    XMPPMessage *message = [XMPPMessage messageWithType:@&quot;chat&quot; to:self.jidChatTo.jid];</span><br><span class="line">//    // 设置bodyType为text</span><br><span class="line">//    [message addAttributeWithName:@&quot;bodyType&quot; stringValue:type];</span><br><span class="line">//    [message addBody:text];</span><br><span class="line">//    [[XMPPManager sharedmanager].stream sendElement:message];</span><br><span class="line">    </span><br><span class="line">    XMPPMessage* message = [[XMPPMessage alloc] initWithType:@&quot;chat&quot; to:self.jidChatTo.jid];</span><br><span class="line">    </span><br><span class="line">    [message addBody:type];</span><br><span class="line">    </span><br><span class="line">    // 设置节点内容</span><br><span class="line">    XMPPElement *attachment = [XMPPElement elementWithName:@&quot;attachment&quot; stringValue:text];</span><br><span class="line">    // 包含子节点</span><br><span class="line">    [message addChild:attachment];</span><br><span class="line">    [[XMPPManager sharedmanager].stream sendElement:message];</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-获取文字聊天内容"><a href="#3-获取文字聊天内容" class="headerlink" title="3.获取文字聊天内容"></a>3.获取文字聊天内容</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">- (void)relodChatMessage &#123;</span><br><span class="line">    XMPPManager *manager = [XMPPManager sharedmanager];</span><br><span class="line">    NSManagedObjectContext *context = manager.archivingStorage.mainThreadManagedObjectContext;</span><br><span class="line">    NSFetchRequest *request = [NSFetchRequest fetchRequestWithEntityName:@&quot;XMPPMessageArchiving_Message_CoreDataObject&quot;];</span><br><span class="line">    </span><br><span class="line">    NSPredicate *predicate = [NSPredicate predicateWithFormat:@&quot;streamBareJidStr=%@ AND bareJidStr=%@&quot;,[UserManager sharedmanager].jid,self.jidChatTo.jid.bare];</span><br><span class="line">    </span><br><span class="line">    NSSortDescriptor *timeSort = [NSSortDescriptor sortDescriptorWithKey:@&quot;timestamp&quot; ascending:YES];</span><br><span class="line">    request.sortDescriptors = @[timeSort];</span><br><span class="line">    request.predicate = predicate;</span><br><span class="line">    </span><br><span class="line">    self.resultController = [[NSFetchedResultsController alloc] initWithFetchRequest:request managedObjectContext:context sectionNameKeyPath:nil cacheName:nil];</span><br><span class="line">    self.resultController.delegate = self;</span><br><span class="line">    NSError *error = nil;</span><br><span class="line">    if ([self.resultController performFetch:&amp;error]) &#123;</span><br><span class="line">        NSLog(@&quot;%@&quot;,error);</span><br><span class="line">    &#125;</span><br><span class="line">    //NSLog(@&quot;-----%@&quot;,self.resultController.fetchedObjects);</span><br><span class="line">    [self getChatMsgArray];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark - NSFetchedResultsControllerDelegate</span><br><span class="line">// 代理方法,当数据发生变化时调用该方法</span><br><span class="line">- (void)controller:(NSFetchedResultsController *)controller didChangeObject:(id)anObject atIndexPath:(nullable NSIndexPath *)indexPath forChangeType:(NSFetchedResultsChangeType)type newIndexPath:(nullable NSIndexPath *)newIndexPath &#123;</span><br><span class="line">    [self relodChatMessage];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 此处获取数据库中的会话数组,对模型类进行赋值,并且设置其单个会话的frame</span><br><span class="line">/**</span><br><span class="line"> *  采用MVVM的设计模式</span><br><span class="line">    提供两个模型:</span><br><span class="line">        &gt;数据模型：存放文字数据\图片数据</span><br><span class="line">        &gt;frame模型：存放数据模型\所有子控件的frame\cell的高度</span><br><span class="line">    其中cell直接拥有一个frame模型(不要直接拥有数据模型).即:使fram模型拥有数据模型</span><br><span class="line">    在cell赋值的时候直接赋值frame模型</span><br><span class="line"> */</span><br><span class="line">- (void)getChatMsgArray &#123;</span><br><span class="line">    [self.chatMsgArray removeAllObjects];</span><br><span class="line">    for (XMPPMessageArchiving_Message_CoreDataObject *msg in self.resultController.fetchedObjects) &#123;</span><br><span class="line">        </span><br><span class="line">        ChatMessageModel *messageModel = [[ChatMessageModel alloc] init];</span><br><span class="line">        // 将模型中的上一条信息的时间戳取出来放到数据模型中处理</span><br><span class="line">        if (self.chatMsgArray.count) &#123;</span><br><span class="line">            ChatFrameModel *preChatFrameModel = self.chatMsgArray.lastObject;</span><br><span class="line">            messageModel.preMsgDate = preChatFrameModel.msg.msg.timestamp;</span><br><span class="line">        &#125;</span><br><span class="line">        // 数据模型的setter</span><br><span class="line">        messageModel.msg = msg;</span><br><span class="line">        </span><br><span class="line">        ChatFrameModel *frameModel = [[ChatFrameModel alloc] init];</span><br><span class="line">        // frame模型的setter</span><br><span class="line">        frameModel.msg = messageModel;</span><br><span class="line">        [self.chatMsgArray addObject:frameModel];</span><br><span class="line"> </span><br><span class="line">        // 图片浏览器</span><br><span class="line">        if ([msg.message.body isEqualToString:@&quot;image&quot;]) &#123;</span><br><span class="line">            XMPPElement *node = msg.message.children.lastObject;</span><br><span class="line">            // 取出消息的解码</span><br><span class="line">            NSString *base64str = node.stringValue;</span><br><span class="line">            NSData *data = [[NSData alloc]initWithBase64EncodedString:base64str options:0];</span><br><span class="line">            UIImage *image = [[UIImage alloc]initWithData:data];</span><br><span class="line">            [self.chatImageArray addObject:image];</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">    [self.myTab reloadData];</span><br><span class="line">    [self scrollToBottom];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于业务逻辑我就不展示了,感兴趣的可以查看demo</p>
<h3 id="4-发送语音聊天"><a href="#4-发送语音聊天" class="headerlink" title="4.发送语音聊天"></a>4.发送语音聊天</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line">#pragma mark ******************************</span><br><span class="line">#pragma mark -- 发送语音聊天信息</span><br><span class="line">- (IBAction)sendVoiceBtn:(UIButton *)sender &#123;</span><br><span class="line">    if (CGRectGetMaxY(self.moreView.frame) == [UIScreen mainScreen].bounds.size.height) &#123;</span><br><span class="line">        self.moreView.frame = kMoreInputViewOriFrame;</span><br><span class="line">        [self.chatTextView resignFirstResponder];</span><br><span class="line">    &#125;</span><br><span class="line">    if (self.inputViewBottonConstraint.constant == 200) &#123;</span><br><span class="line">        [self.chatTextView becomeFirstResponder];</span><br><span class="line">        [self dissmissMoreInputViewWithAniation:YES];</span><br><span class="line">    &#125;</span><br><span class="line">    if (!self.sendVoiceBtn.hidden) &#123;</span><br><span class="line">        [self.chatTextView becomeFirstResponder];</span><br><span class="line">        //self.inputViewBottonConstraint.constant = 0;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        if ([self.chatTextView isFirstResponder]) &#123;</span><br><span class="line">            [self.chatTextView resignFirstResponder];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    self.sendVoiceBtn.hidden = sender.selected;</span><br><span class="line">    sender.selected = !sender.selected;</span><br><span class="line">    UIImage *normalImage = sender.selected ? [UIImage imageNamed:@&quot;ToolViewKeyboard&quot;] : [UIImage imageNamed:@&quot;ToolViewInputVoice&quot;];</span><br><span class="line">    UIImage *highlightImage = sender.selected ? [UIImage imageNamed:@&quot;ToolViewKeyboardHL&quot;] : [UIImage imageNamed:@&quot;ToolViewInputVoiceHL&quot;];</span><br><span class="line">    [sender setImage:normalImage forState:UIControlStateNormal];</span><br><span class="line">    [sender setImage:highlightImage forState:UIControlStateHighlighted];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 在按钮上按下按钮开始录音</span><br><span class="line">- (IBAction)sendTouchDown:(UIButton *)sender &#123;</span><br><span class="line">    NSLog(@&quot;%s, line = %d&quot;, __FUNCTION__, __LINE__);</span><br><span class="line">    self.sendVoiceBtn.backgroundColor = [UIColor lightGrayColor];</span><br><span class="line">    // 设置提示框</span><br><span class="line">    popVoiceView *voiceV = [popVoiceView voiceAlertPopView];</span><br><span class="line">    voiceV.bounds = CGRectMake(0, 0, 150, 150);</span><br><span class="line">    CGFloat centerX = [UIScreen mainScreen].bounds.size.width / 2.0;</span><br><span class="line">    CGFloat centerY = [UIScreen mainScreen].bounds.size.height / 2.0;</span><br><span class="line">    voiceV.center = CGPointMake(centerX, centerY);</span><br><span class="line">    self.voiceView = voiceV;</span><br><span class="line">    [self.view addSubview:self.voiceView];</span><br><span class="line">    </span><br><span class="line">    // 录音</span><br><span class="line">    [self.audioRecorder record];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 在按钮上抬起手指发送语音</span><br><span class="line">- (IBAction)sendTouchUpInside:(UIButton *)sender &#123;</span><br><span class="line">    NSLog(@&quot;%s, line = %d&quot;, __FUNCTION__, __LINE__);</span><br><span class="line">    self.sendVoiceBtn.backgroundColor = BackGround243Color;</span><br><span class="line">    NSTimeInterval time = self.audioRecorder.currentTime;</span><br><span class="line">    </span><br><span class="line">    if (time &lt; 1.5) &#123;</span><br><span class="line">        // 时间小于1.5秒不发送,大于1.5秒才发送</span><br><span class="line">        // 停止录音</span><br><span class="line">        [self.audioRecorder stop];</span><br><span class="line">        // 删除录音文件</span><br><span class="line">        [self.audioRecorder deleteRecording];</span><br><span class="line">        </span><br><span class="line">        self.voiceView.voiceImageV.image = [UIImage imageNamed:@&quot;QQ20160818-3&quot;];</span><br><span class="line">        self.voiceView.voiceTitleLab.text = @&quot;说话时间太短&quot;;</span><br><span class="line">        </span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // 停止录音</span><br><span class="line">        [self.audioRecorder stop];</span><br><span class="line">        </span><br><span class="line">        // 发送语音</span><br><span class="line">        NSString *urlStr = [NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) lastObject];</span><br><span class="line">        urlStr = [urlStr stringByAppendingPathComponent:kRecordAudioFile];</span><br><span class="line">        NSData *voiceData = [NSData dataWithContentsOfFile:urlStr];</span><br><span class="line">        [self sendVoiceMessageWithData:voiceData bodyType:@&quot;voice&quot; withDuringTime:time];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [self.voiceView removeFromSuperview];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">- (void)sendVoiceMessageWithData:(NSData *)data bodyType:(NSString *)type withDuringTime:(NSTimeInterval)time&#123;</span><br><span class="line">    XMPPMessage* message = [[XMPPMessage alloc] initWithType:@&quot;chat&quot; to:self.jidChatTo.jid];</span><br><span class="line">    // 将时间传过去</span><br><span class="line">    NSString *timeStr = [NSString stringWithFormat:@&quot;%f&quot;,time];</span><br><span class="line">    [message addAttributeWithName:@&quot;duringTime&quot; stringValue:timeStr];</span><br><span class="line">    [message addBody:type];</span><br><span class="line"></span><br><span class="line">    NSString *base64str = [data base64EncodedStringWithOptions:0];</span><br><span class="line"></span><br><span class="line">    XMPPElement *attachment = [XMPPElement elementWithName:@&quot;attachment&quot; stringValue:base64str];</span><br><span class="line"></span><br><span class="line">    [message addChild:attachment];</span><br><span class="line">    [[XMPPManager sharedmanager].stream sendElement:message];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 手指拖到按钮外面将要取消录音</span><br><span class="line">- (IBAction)sendDragOutside:(UIButton *)sender &#123;</span><br><span class="line">    NSLog(@&quot;%s, line = %d&quot;, __FUNCTION__, __LINE__);</span><br><span class="line">    self.voiceView.voiceImageV.image = [UIImage imageNamed:@&quot;QQ20160818-2&quot;];</span><br><span class="line">    self.voiceView.voiceTitleLab.text = @&quot;松开手指, 取消发送&quot;;</span><br><span class="line">    self.voiceView.voiceTitleLab.backgroundColor = [UIColor colorWithRed:0.826 green:0.0 blue:0.0 alpha:1.0];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 在按钮外面抬起手指取消录音</span><br><span class="line">- (IBAction)sendTouchUpOutside:(UIButton *)sender &#123;</span><br><span class="line">    NSLog(@&quot;%s, line = %d&quot;, __FUNCTION__, __LINE__);</span><br><span class="line">    [self.voiceView removeFromSuperview];</span><br><span class="line">    </span><br><span class="line">    // 停止录音</span><br><span class="line">    [self.audioRecorder stop];</span><br><span class="line">    // 删除录音文件</span><br><span class="line">    [self.audioRecorder deleteRecording];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 设置音频保存路径</span><br><span class="line">- (NSURL *)getSavePath &#123;</span><br><span class="line">    NSString *urlStr = [NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) lastObject];</span><br><span class="line">    urlStr = [urlStr stringByAppendingPathComponent:kRecordAudioFile];</span><br><span class="line">    NSURL *url = [NSURL URLWithString:urlStr];</span><br><span class="line">    </span><br><span class="line">    return url;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> *  设置音频会话</span><br><span class="line">    注意:一定要添加音频会话,不然真机上的录音时间不对,并且不能进行播放音频</span><br><span class="line"> */</span><br><span class="line">-(void)setAudioSession&#123;</span><br><span class="line">    AVAudioSession *audioSession=[AVAudioSession sharedInstance];</span><br><span class="line">    //设置为播放和录音状态，以便可以在录制完之后播放录音</span><br><span class="line">    [audioSession setCategory:AVAudioSessionCategoryPlayAndRecord error:nil];</span><br><span class="line">    [audioSession setActive:YES error:nil];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 录音文件设置</span><br><span class="line">- (NSDictionary *)getAudioSetting &#123;</span><br><span class="line">    NSMutableDictionary *dicM = [NSMutableDictionary dictionary];</span><br><span class="line">    // 设置录音格式</span><br><span class="line">    [dicM setObject:@(kAudioFormatLinearPCM) forKey:AVFormatIDKey];</span><br><span class="line">    // 设置录音采样率,8000是电话采样率,对于一般录音已经够了</span><br><span class="line">    [dicM setObject:@(8000) forKey:AVSampleRateKey];</span><br><span class="line">    // 设置通道,这里采用单声道</span><br><span class="line">    [dicM setObject:@(1) forKey:AVNumberOfChannelsKey];</span><br><span class="line">    // 每个采样点位数,分别为8,16,24,32</span><br><span class="line">    [dicM setObject:@(8) forKey:AVLinearPCMBitDepthKey];</span><br><span class="line">    // 是否使用浮点数采样</span><br><span class="line">    [dicM setObject:@(YES) forKey:AVLinearPCMIsFloatKey];</span><br><span class="line">    // ...其他设置</span><br><span class="line">    return dicM;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark -- AVAudioRecorderDelegate</span><br><span class="line">// 录音完成</span><br><span class="line">- (void)audioRecorderDidFinishRecording:(AVAudioRecorder *)recorder successfully:(BOOL)flag &#123;</span><br><span class="line">    //NSLog(@&quot;录音完毕&quot;);</span><br><span class="line">&#125;</span><br><span class="line">#pragma mark -- AVAudioPlayerDelegate</span><br><span class="line"></span><br><span class="line">- (void)audioPlayerDidFinishPlaying:(AVAudioPlayer *)player successfully:(BOOL)flag &#123;</span><br><span class="line">    NSLog(@&quot;播放完毕&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-播放语音"><a href="#5-播放语音" class="headerlink" title="5.播放语音"></a>5.播放语音</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">if ([chatFrameModel.msg.msg.message.body isEqualToString:@&quot;voice&quot;]) &#123;</span><br><span class="line">   if (self.audioPlayer.isPlaying) &#123;</span><br><span class="line">       [self.audioPlayer stop];</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   XMPPElement *node = chatFrameModel.msg.msg.message.children.lastObject;</span><br><span class="line">   // 取出消息的解码</span><br><span class="line">   NSString *base64str = node.stringValue;</span><br><span class="line">   NSData *data = [[NSData alloc]initWithBase64EncodedString:base64str options:0];</span><br><span class="line">   </span><br><span class="line">   self.audioPlayer = [[AVAudioPlayer alloc] initWithData:data error:NULL];</span><br><span class="line">   self.audioPlayer.delegate = self;</span><br><span class="line">   [self.audioPlayer play];</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-发送图片信息"><a href="#6-发送图片信息" class="headerlink" title="6.发送图片信息"></a>6.发送图片信息</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">XMPPMessage* message = [[XMPPMessage alloc] initWithType:@&quot;chat&quot; to:self.jidChatTo.jid];</span><br><span class="line">    // 设置bodyType类型值为image</span><br><span class="line">    //[message addAttributeWithName:@&quot;bodyType&quot; stringValue:type];</span><br><span class="line">#warning 此处采用图片,语音等传输方式为XML携带信息,所以传输速度慢,因为未搭建文件服务器,所以采用该种办法,建议采用文件服务器方式,传递URL</span><br><span class="line">    // 该处设置message的body为文件类型,后面对文件类型的判断由body来实现,其中尝试使用[message addAttributeWithName:@&quot;bodyType&quot; stringValue:type];来实现文件类型的判断但未成功,原因暂时未知</span><br><span class="line">    [message addBody:type];</span><br><span class="line">    </span><br><span class="line">    // 转换成base64的编码</span><br><span class="line">    NSString *base64str = [data base64EncodedStringWithOptions:0];</span><br><span class="line">    </span><br><span class="line">    // 设置节点内容</span><br><span class="line">    XMPPElement *attachment = [XMPPElement elementWithName:@&quot;attachment&quot; stringValue:base64str];</span><br><span class="line">    </span><br><span class="line">    // 包含子节点</span><br><span class="line">    [message addChild:attachment];</span><br><span class="line"></span><br><span class="line">#warning 此处采用的是文件服务器方式传输,但由于未建立文件服务器,所以传输对象为写死的一图片,语音等文件的url,仅供测试使用</span><br><span class="line">    //[message addBody:@&quot;http://img5.duitang.com/uploads/item/201407/24/20140724054410_5ctE2.jpeg&quot;];</span><br><span class="line">    // 发送图片消息</span><br><span class="line">    [[XMPPManager sharedmanager].stream sendElement:message];</span><br></pre></td></tr></table></figure>
<p>7.会话内容回执<br>通过单元格代理方式来获得会话内容回执进行音频播放和图片浏览<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#pragma mark ******************************</span><br><span class="line">#pragma mark --ChatCellDelegate</span><br><span class="line">- (void)getCurrentChatCell:(ChatTableViewCell *)cell withCurrentChatFrame:(ChatFrameModel *)chatFrameModel &#123;</span><br><span class="line">    //NSString *chatType = [chatFrameModel.msg.msg.message attributeStringValueForName:@&quot;bodyType&quot;];</span><br><span class="line">    if ([chatFrameModel.msg.msg.message.body isEqualToString:@&quot;image&quot;]) &#123;</span><br><span class="line">        MWPhotoBrowser *browser = [[MWPhotoBrowser alloc] initWithDelegate:self];</span><br><span class="line">        NSUInteger index = 0;</span><br><span class="line">        // 如果当前单元格中的url存在,则在数组中找到与之匹配的,并找出其序号</span><br><span class="line">        if (chatFrameModel.msg.msg.body) &#123;</span><br><span class="line">            index = [self.chatImageArray indexOfObject:chatFrameModel.msg.msg.body];</span><br><span class="line">        &#125;</span><br><span class="line">        // 设置图片查看器当前查看的位置</span><br><span class="line">        [browser setCurrentPhotoIndex:index];</span><br><span class="line">        // 跳转到图片查看器</span><br><span class="line">        [self.navigationController pushViewController:browser animated:YES];</span><br><span class="line">    &#125; else if ([chatFrameModel.msg.msg.message.body isEqualToString:@&quot;voice&quot;]) &#123;</span><br><span class="line">        if (self.audioPlayer.isPlaying) &#123;</span><br><span class="line">            [self.audioPlayer stop];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        XMPPElement *node = chatFrameModel.msg.msg.message.children.lastObject;</span><br><span class="line">        // 取出消息的解码</span><br><span class="line">        NSString *base64str = node.stringValue;</span><br><span class="line">        NSData *data = [[NSData alloc]initWithBase64EncodedString:base64str options:0];</span><br><span class="line">        </span><br><span class="line">        self.audioPlayer = [[AVAudioPlayer alloc] initWithData:data error:NULL];</span><br><span class="line">        self.audioPlayer.delegate = self;</span><br><span class="line">        [self.audioPlayer play];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="8-键盘高度"><a href="#8-键盘高度" class="headerlink" title="8.键盘高度"></a>8.键盘高度</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#pragma mak -- 更改键盘高度</span><br><span class="line">- (void)keyboardFrameChange:(NSNotification *)sender &#123;</span><br><span class="line">    // 获得键盘改变后的frame</span><br><span class="line">    NSValue *keyboardFrame = sender.userInfo[UIKeyboardFrameEndUserInfoKey];</span><br><span class="line">    CGRect rect = [keyboardFrame CGRectValue];</span><br><span class="line">    CGFloat height = CGRectGetHeight(rect);</span><br><span class="line">    // 计算聊天窗口的底部偏移量</span><br><span class="line">    if (rect.origin.y == [UIScreen mainScreen].bounds.size.height) &#123;</span><br><span class="line">        self.inputViewBottonConstraint.constant = 0;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        self.inputViewBottonConstraint.constant = height;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [UIView animateWithDuration:0.25 animations:^&#123;</span><br><span class="line">        [self.view layoutIfNeeded];</span><br><span class="line">    &#125;];</span><br><span class="line">    [self scrollToBottom];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/08/22/XMPP/(%E5%8D%81%E4%BA%8C)%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E4%B9%8BXMPPFramework%E8%8A%B1%E5%90%8D%E5%86%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/android-chrome-384x384.png">
      <meta itemprop="name" content="HuiYou Hua">
      <meta itemprop="description" content="iOS 开发相关日常总结记录。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuiYouHua">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/08/22/XMPP/(%E5%8D%81%E4%BA%8C)%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E4%B9%8BXMPPFramework%E8%8A%B1%E5%90%8D%E5%86%8C/" class="post-title-link" itemprop="url">(十二)即时通讯之XMPPFramework花名册</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-08-22 00:02:53" itemprop="dateCreated datePublished" datetime="2016-08-22T00:02:53+08:00">2016-08-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/XMPP/" itemprop="url" rel="index"><span itemprop="name">XMPP</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><blockquote>
<p>这也是本人第一次琢磨关于即时通讯方面的内容,结合网上查看的相关资料搭建出来的仿微信小demo,如有意见请多多指教</p>
</blockquote>
<p><strong>具体项目可以在github<a target="_blank" rel="noopener" href="https://git.oschina.net/huyoyu/WeiChat">WeiChat</a>下载进行查看,如若各位看官老爷觉得还可以请点star</strong></p>
<p>续前篇<a target="_blank" rel="noopener" href="http://www.jianshu.com/p/6b3c12790f8e">(十)即时通讯之XMPPFramework登陆注册</a></p>
<p>续前篇<a target="_blank" rel="noopener" href="http://www.jianshu.com/p/b1be451ccf5c">(十一)即时通讯之XMPPFramework电子名片</a></p>
<p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220519234204624.png" alt="服务器地址"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">**Attention,这里需要改成自己的服务器地址和端口号</span><br><span class="line">并且数据库和服务器一定要开启哟,不然没法登陆的哟**</span><br><span class="line">#ifdef DEBUG</span><br><span class="line">#define kHostName @&quot;192.168.199.111&quot;</span><br><span class="line">//#define kHostName @&quot;127.0.0.1&quot;</span><br><span class="line">#define kHostPort 5222</span><br><span class="line">#else</span><br><span class="line">#define kHostNanme @&quot;&quot;</span><br><span class="line">#define kHostPort 5222</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<p>本篇讲的是XMPPFramework的花名册部分</p>
<h3 id="1-什么是花名册"><a href="#1-什么是花名册" class="headerlink" title="1.什么是花名册"></a>1.什么是花名册</h3><p> 花名册就是XMPPRoster类,XMPPRoster可以处理和好友的相关事情,比如或获取好友列表,添加好友,接收好友请求,同意好友添加,拒绝好友添加等.</p>
<h3 id="2-XMPPRoster相关类"><a href="#2-XMPPRoster相关类" class="headerlink" title="2.XMPPRoster相关类"></a>2.XMPPRoster相关类</h3><ul>
<li>XMPPRoster（花名册）</li>
<li>XMPPRosterCoreDataStorage（花名册存储类）</li>
<li>XMPPRosterStorage（花名册存储代理）</li>
<li>XMPPRosterDelegate（花名册操作类）</li>
</ul>
<h3 id="3-XMPPRoster的使用"><a href="#3-XMPPRoster的使用" class="headerlink" title="3.XMPPRoster的使用"></a>3.XMPPRoster的使用</h3><p>其实这些模块的使用与之前的模块大同小异,请接着看:</p>
<h5 id="3-1XMPPRoster的激活"><a href="#3-1XMPPRoster的激活" class="headerlink" title="3.1XMPPRoster的激活"></a>3.1XMPPRoster的激活</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">         *  XMPPRoster模块激活</span><br><span class="line">         */</span><br><span class="line">        self.rosterStorage = [XMPPRosterCoreDataStorage sharedInstance];</span><br><span class="line">        self.roster = [[XMPPRoster alloc] initWithRosterStorage:self.rosterStorage];</span><br><span class="line">        [self.roster activate:self.stream];</span><br></pre></td></tr></table></figure>
<h5 id="3-2获取好友列表"><a href="#3-2获取好友列表" class="headerlink" title="3.2获取好友列表"></a>3.2获取好友列表</h5><p>查询步骤:</p>
<ul>
<li>1.设置代理XMPPRosterDelegate,这是为了监听后面的好友请求</li>
<li>2.通过XMPPRosterCoreDataStorage的数据库获得管理对象上下文</li>
<li>3.设置请求实体对象</li>
<li>4.设置查询条件</li>
<li>5.排序</li>
<li>6.执行请求NSFetchedResultsController(代理),</li>
<li>7.缓存到本地刷新</li>
</ul>
<p><strong>注意:设置查询条件的条件</strong></p>
<p>这里使用了一个类NSFetchedResultsController,是将查询和表结合的一种控件<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">// 通常有两种方式,这里就采用这种方式,如有兴趣可以查阅相关资料</span><br><span class="line">    XMPPManager *manager = [XMPPManager sharedmanager];</span><br><span class="line">    [manager.roster addDelegate:self delegateQueue:dispatch_get_main_queue()];</span><br><span class="line">    UserManager *user = [UserManager sharedmanager];</span><br><span class="line">    // 通过XMPPRosterCoreDataStorage的数据库获得管理对象上下文</span><br><span class="line">    NSManagedObjectContext *context = manager.rosterStorage.mainThreadManagedObjectContext;</span><br><span class="line">    // 设置请求实体对象,在数据库中名为XMPPUserCoreDataStorageObject的一张表</span><br><span class="line">    NSFetchRequest *request = [[NSFetchRequest alloc] initWithEntityName:@&quot;XMPPUserCoreDataStorageObject&quot;];</span><br><span class="line">    // 设置谓词查询条件,用户名是自己的JID</span><br><span class="line">    NSPredicate *predicate = [NSPredicate predicateWithFormat:@&quot;streamBareJidStr=%@&quot;,user.jid];</span><br><span class="line">    request.predicate = predicate;</span><br><span class="line">    </span><br><span class="line">    // 排序:按照用户名进行排序</span><br><span class="line">    NSSortDescriptor *sort = [NSSortDescriptor sortDescriptorWithKey:@&quot;displayName&quot; ascending:YES]</span><br><span class="line">    ;</span><br><span class="line">    request.sortDescriptors = @[sort];</span><br><span class="line">    </span><br><span class="line">    _fetchedRequestC = [[NSFetchedResultsController alloc] initWithFetchRequest:request managedObjectContext:context sectionNameKeyPath:nil cacheName:nil];</span><br><span class="line">    _fetchedRequestC.delegate = self;</span><br><span class="line"></span><br><span class="line">    NSError *error = nil;</span><br><span class="line">    if ([_fetchedRequestC performFetch:&amp;error]) &#123;</span><br><span class="line">        NSLog(@&quot;%@&quot;,error);</span><br><span class="line">    &#125;</span><br><span class="line">    [self.friendsArray removeAllObjects];</span><br><span class="line">    [self.friendsArray addObjectsFromArray:_fetchedRequestC.fetchedObjects];</span><br><span class="line">    [self.tableView reloadData];</span><br><span class="line">    </span><br><span class="line">    for (XMPPUserCoreDataStorageObject *obj in self.friendsArray) &#123;</span><br><span class="line">        //NSLog(@&quot;%@ ++ %@ ++ %@&quot;, obj.jidStr, obj.nickname, obj.displayName);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#pragma mark - NSFetchedResultsControllerDelegate</span><br><span class="line">// 代理方法,当数据发生变化时调用该方法</span><br><span class="line">- (void)controller:(NSFetchedResultsController *)controller didChangeObject:(id)anObject atIndexPath:(nullable NSIndexPath *)indexPath forChangeType:(NSFetchedResultsChangeType)type newIndexPath:(nullable NSIndexPath *)newIndexPath &#123;</span><br><span class="line">    NSLog(@&quot;数据发生变化&quot;);</span><br><span class="line">    [self.friendsArray removeAllObjects];</span><br><span class="line">    [self.friendsArray addObjectsFromArray:controller.fetchedObjects];</span><br><span class="line">    for (XMPPUserCoreDataStorageObject *obj in self.friendsArray) &#123;</span><br><span class="line">        //NSLog(@&quot;%@ -- %@ -- %@&quot;, obj.jidStr, obj.nickname, obj.displayName);</span><br><span class="line">    &#125;</span><br><span class="line">    [self.tableView reloadData];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="3-3添加好友"><a href="#3-3添加好友" class="headerlink" title="3.3添加好友"></a>3.3添加好友</h5><p><strong>注意:<br>  1.不能添加自己为好友<br>  2.不能添加已存在的好友</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">if ([self.searchTextField.text isEqualToString:[UserManager sharedmanager].loginName]) &#123;</span><br><span class="line">    [self showAlert:@&quot;不能添加自己为好友&quot;];</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NSString *jidStr = [NSString stringWithFormat:@&quot;%@@%@&quot;,self.searchTextField.text,kHostName];</span><br><span class="line">XMPPJID *jid = [XMPPJID jidWithString:jidStr];</span><br><span class="line"></span><br><span class="line">XMPPManager *manager = [XMPPManager sharedmanager];</span><br><span class="line">if ([manager.rosterStorage userExistsWithJID:jid xmppStream:manager.stream]) &#123;</span><br><span class="line">    [self showAlert:@&quot;不能重复添加好友&quot;];</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[manager.roster subscribePresenceToUser:jid];</span><br><span class="line">[self showAlert:@&quot;已发送添加好友请求&quot;];</span><br></pre></td></tr></table></figure>
<h5 id="3-4删除好友"><a href="#3-4删除好友" class="headerlink" title="3.4删除好友"></a>3.4删除好友</h5><p><strong>注意:<br>  1.从服务器删<br>  2.从本地缓存删<br>  3.从表中删</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">XMPPUserCoreDataStorageObject *friend = self.friendsArray[indexPath.row];</span><br><span class="line">// 从服务器删</span><br><span class="line">[[XMPPManager sharedmanager].roster removeUser:friend.jid];</span><br><span class="line">// 从数组缓存中删</span><br><span class="line">[self.friendsArray removeObject:friend];</span><br><span class="line">// 从表中删</span><br><span class="line">[tableView deleteRowsAtIndexPaths:@[[NSIndexPath indexPathForRow:indexPath.row inSection:indexPath.section]] withRowAnimation:UITableViewRowAnimationFade];</span><br></pre></td></tr></table></figure></p>
<h5 id="3-5监听好友请求"><a href="#3-5监听好友请求" class="headerlink" title="3.5监听好友请求"></a>3.5监听好友请求</h5><p><strong>注意:<br>  1.可接受<br>  2.可拒绝</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">XMPPRoster *roster = [XMPPManager sharedmanager].roster;</span><br><span class="line">NSString *message = [NSString stringWithFormat:@&quot;%@请求添加你为好友&quot;,presence.from.user];</span><br><span class="line">XIAlertView *alertView = [[XIAlertView alloc] initWithTitle:@&quot;提示&quot; message:message cancelButtonTitle:@&quot;拒绝&quot;];</span><br><span class="line">[alertView addDefaultStyleButtonWithTitle:@&quot;接收&quot; handler:^(XIAlertView *alertView, XIAlertButtonItem *buttonItem) &#123;</span><br><span class="line">    if (buttonItem == 0) &#123;</span><br><span class="line">        // 接受</span><br><span class="line">        [roster rejectPresenceSubscriptionRequestFrom:presence.from];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">         / /拒绝</span><br><span class="line">         [roster acceptPresenceSubscriptionRequestFrom:presence.from andAddToRoster:YES];</span><br><span class="line">    &#125;</span><br><span class="line">    [alertView dismiss];</span><br><span class="line">&#125;];</span><br><span class="line">[alertView show];</span><br></pre></td></tr></table></figure></p>
<p>未完待续…</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/08/22/XMPP/(%E5%8D%81%E4%B8%80)%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E4%B9%8BXMPPFramework%E7%94%B5%E5%AD%90%E5%90%8D%E7%89%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/android-chrome-384x384.png">
      <meta itemprop="name" content="HuiYou Hua">
      <meta itemprop="description" content="iOS 开发相关日常总结记录。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuiYouHua">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/08/22/XMPP/(%E5%8D%81%E4%B8%80)%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E4%B9%8BXMPPFramework%E7%94%B5%E5%AD%90%E5%90%8D%E7%89%87/" class="post-title-link" itemprop="url">(十一)即时通讯之XMPPFramework电子名片</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-08-22 00:01:53" itemprop="dateCreated datePublished" datetime="2016-08-22T00:01:53+08:00">2016-08-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/XMPP/" itemprop="url" rel="index"><span itemprop="name">XMPP</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><blockquote>
<p>这也是本人第一次琢磨关于即时通讯方面的内容,结合网上查看的相关资料搭建出来的仿微信小demo,如有意见请多多指教</p>
</blockquote>
<p><strong>具体项目可以在github<a target="_blank" rel="noopener" href="https://git.oschina.net/huyoyu/WeiChat">WeiChat</a>下载进行查看,如若各位看官老爷觉得还可以请点star</strong></p>
<p>续前篇<a target="_blank" rel="noopener" href="http://www.jianshu.com/p/6b3c12790f8e">(十)即时通讯之XMPPFramework登陆注册</a></p>
<p><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/1240-20220519234154328.png" alt="服务器地址"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">**Attention,这里需要改成自己的服务器地址和端口号</span><br><span class="line">并且数据库和服务器一定要开启哟,不然没法登陆的哟**</span><br><span class="line">#ifdef DEBUG</span><br><span class="line">#define kHostName @&quot;192.168.199.111&quot;</span><br><span class="line">//#define kHostName @&quot;127.0.0.1&quot;</span><br><span class="line">#define kHostPort 5222</span><br><span class="line">#else</span><br><span class="line">#define kHostNanme @&quot;&quot;</span><br><span class="line">#define kHostPort 5222</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<p>本篇讲的是XMPPFramework的电子名片部分</p>
<h3 id="1-什么叫电子名片"><a href="#1-什么叫电子名片" class="headerlink" title="1.什么叫电子名片"></a>1.什么叫电子名片</h3><p>在Extensions中有XEP-0054扩展，提供了一种可以通过XMPP发送电子名片的机制。</p>
<p>vCard，也叫Versitcard，vCard的常用文件扩展名是.vcf。在XMPP中通过XMPPvCardTemp和XMPPvCardCoreDataStorage两个类来实现。<br>vCard是电子名片的文件格式标准，一般附加在电子邮件之后，但也可以用于其它场合，比如在因特网上相互交换。</p>
<h3 id="2-电子名片相关类"><a href="#2-电子名片相关类" class="headerlink" title="2.电子名片相关类"></a>2.电子名片相关类</h3><ul>
<li>XMPPvCardTemp 代表电子名片<br>  它是继承自NSXMLElement的,提供了很多属性,比如出生日期,姓名,地址,手机号,邮箱等.</li>
<li>XMPPvCardCoreDataStorage 代表电子名片在core data存储<br>  它是一个单例类,直接与数据库相关,它遵循 XMPPvCardAvatarStorage,表示头像模块的存储代理,就可以将电子头像写入电子名片数据存储中</li>
<li>XMPPvCardTempModule ,继承自XMPPModule类,用于提供电子名片增、删、改、查操作</li>
</ul>
<h3 id="3-XMPPvCardTemp的使用"><a href="#3-XMPPvCardTemp的使用" class="headerlink" title="3.XMPPvCardTemp的使用"></a>3.XMPPvCardTemp的使用</h3><p><strong>注意:</strong><br><strong>1. XMPPvCardTemp可以在各个界面获得,用于用户信息的展示<br>  2.当对XMPPvCardTemp进行了修改时,需要想服务器进行更新<br>  3.可以通过代理方法获得用户头像,使用传值来获得头像展示</strong></p>
<h5 id="3-1XMPPvCardTemp的激活"><a href="#3-1XMPPvCardTemp的激活" class="headerlink" title="3.1XMPPvCardTemp的激活"></a>3.1XMPPvCardTemp的激活</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">         *  XMPPvCardCoreDataStorage和XMPPvCardTempModule模块的激活与设置代理</span><br><span class="line">         */</span><br><span class="line">        self.vCardStorage = [XMPPvCardCoreDataStorage sharedInstance];</span><br><span class="line">        self.vCardModule = [[XMPPvCardTempModule alloc] initWithvCardStorage:self.vCardStorage];</span><br><span class="line">        [self.vCardModule activate:self.stream];</span><br><span class="line">        [self.vCardModule addDelegate:self delegateQueue:dispatch_get_main_queue()];</span><br><span class="line">        </span><br><span class="line">        /**</span><br><span class="line">         *  XMPPvCardAvatarModule头像模块激活与设置代理</span><br><span class="line">         */</span><br><span class="line">        self.vCardAvatar = [[XMPPvCardAvatarModule alloc] initWithvCardTempModule:self.vCardModule];</span><br><span class="line">        [self.vCardAvatar activate:self.stream];</span><br><span class="line">        [self.vCardAvatar addDelegate:self delegateQueue:dispatch_get_main_queue()];</span><br></pre></td></tr></table></figure>
<h5 id="3-2XMPPvCardTemp的使用"><a href="#3-2XMPPvCardTemp的使用" class="headerlink" title="3.2XMPPvCardTemp的使用"></a>3.2XMPPvCardTemp的使用</h5><p>在微信主界面中我的界面可以通过电子名片来获得用户相关信息<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">    *  从电子名片的模型中获取自已用户信息的电子名片展示在个人信息中</span><br><span class="line">    */</span><br><span class="line">   XMPPManager *manager = [XMPPManager sharedmanager];</span><br><span class="line">   XMPPvCardTemp *vCard = manager.vCardModule.myvCardTemp;</span><br><span class="line">   self.nameLab.text = vCard.nickname;</span><br><span class="line">   self.weiXinNameLab.text = [NSString stringWithFormat:@&quot;微信号:  %@&quot;,[UserManager sharedmanager].loginName];</span><br><span class="line">   self.headerImageV.image = [UIImage imageWithData:vCard.photo];</span><br><span class="line">   </span><br><span class="line">   // 头像发生改变时,回调block改变个人信息的头像</span><br><span class="line">   [manager xmppGetUserHeaderImage:^(UIImage *image) &#123;</span><br><span class="line">       self.headerImageV.image = image;</span><br><span class="line">   &#125;];</span><br></pre></td></tr></table></figure><br>在微信的用户设置界面可以对用户的信息相关设置,这里举例对用户头像的设置<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 选取头像成功后需要手动将数据更新到服务器</span><br><span class="line">    XMPPManager *manager = [XMPPManager sharedmanager];</span><br><span class="line">    XMPPvCardTemp *vCard = manager.vCardModule.myvCardTemp;</span><br><span class="line">    vCard.photo = UIImageJPEGRepresentation(image, 0.75);</span><br><span class="line">    //vCard.nickname = @&quot;华惠友&quot;;</span><br><span class="line">    // 更新到服务器</span><br><span class="line">    [manager.vCardModule updateMyvCardTemp:vCard];</span><br></pre></td></tr></table></figure></p>
<h5 id="3-3当用户电子名片代理"><a href="#3-3当用户电子名片代理" class="headerlink" title="3.3当用户电子名片代理"></a>3.3当用户电子名片代理</h5><p>当用户的名片信息或头像发生变化时,如果在激活模块中设置了代理,那么就可以通过代理来获得用户的名片信息<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#pragma mark -- XMPPvCardTempModuleDelegate名片代理</span><br><span class="line">/**</span><br><span class="line"> *  当用户名片信息发生改变时,调用该方法</span><br><span class="line"> */</span><br><span class="line">- (void)xmppvCardTempModule:(XMPPvCardTempModule *)vCardTempModule</span><br><span class="line">        didReceivevCardTemp:(XMPPvCardTemp *)vCardTemp</span><br><span class="line">                     forJID:(XMPPJID *)jid &#123;</span><br><span class="line">    // 打印用户信息</span><br><span class="line">    XMPPvCardTemp *temp = [self.vCardStorage vCardTempForJID:jid xmppStream:self.stream];</span><br><span class="line">    //NSLog(@&quot;%@&quot;,temp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark ******************************</span><br><span class="line">#pragma mark -- XMPPvCardAvatarDelegate名片代理</span><br><span class="line">/**</span><br><span class="line"> *  当用户名片头像发生改变时,调用该方法</span><br><span class="line"> */</span><br><span class="line">- (void)xmppvCardAvatarModule:(XMPPvCardAvatarModule *)vCardTempModule</span><br><span class="line">              didReceivePhoto:(UIImage *)photo</span><br><span class="line">                       forJID:(XMPPJID *)jid &#123;</span><br><span class="line">    NSLog(@&quot;头像发生变化&quot;);</span><br><span class="line">    if (self.imageBlock) &#123;</span><br><span class="line">        self.imageBlock(photo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>未完待续…</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/08/20/XMPP/(%E5%8D%81)%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E4%B9%8BXMPPFramework%E7%99%BB%E9%99%86%E6%B3%A8%E5%86%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/android-chrome-384x384.png">
      <meta itemprop="name" content="HuiYou Hua">
      <meta itemprop="description" content="iOS 开发相关日常总结记录。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuiYouHua">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/08/20/XMPP/(%E5%8D%81)%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E4%B9%8BXMPPFramework%E7%99%BB%E9%99%86%E6%B3%A8%E5%86%8C/" class="post-title-link" itemprop="url">(十)即时通讯之XMPPFramework登陆注册</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-08-20 00:10:53" itemprop="dateCreated datePublished" datetime="2016-08-20T00:10:53+08:00">2016-08-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/XMPP/" itemprop="url" rel="index"><span itemprop="name">XMPP</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><blockquote>
<p>这也是本人第一次琢磨关于即时通讯方面的内容,结合网上查看的相关资料搭建出来的仿微信小demo,如有意见请多多指教</p>
<p>写了这么多,尼玛终于到正题了,前面9篇讲的都是基本概念及相关环境的搭建,这里列举一下:</p>
<ul>
<li>Sokcet套接字的简介</li>
<li>网络七层协议,TCP/UDP的概念</li>
<li>CocoaSocket的使用</li>
<li>XMPP协议的简介</li>
<li>XMPP通讯环境SQL的搭建</li>
<li>XMPP通讯环境服务器openfire的搭建</li>
<li>XMPP通讯环境客户端message,Aduim,Spark的搭建</li>
<li>XMPPFramework框架的导入及简单介绍</li>
</ul>
</blockquote>
<p><strong>具体项目可以在github<a target="_blank" rel="noopener" href="https://git.oschina.net/huyoyu/WeiChat">WeiChat</a>下载进行查看,如若各位看官老爷觉得还可以请点star</strong></p>
<p><strong>下面开始进入正题</strong><br><strong>XMPPFramework的使用</strong></p>
<p><strong>看图</strong></p>
<ul>
<li><p>用户注册<br><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/strip.gif" alt="注册.gif"></p>
</li>
<li><p>登陆<br><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/strip-20220519234142098.gif" alt="登陆"></p>
</li>
<li><p>切换用户登陆<br><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/strip-20220519234142477.gif" alt="切换用户登陆.gif"></p>
</li>
<li><p>注销<br><img src="http://huayoyu-1254261238.cossh.myqcloud.com/md/strip-20220519234142702.gif" alt="注销"></p>
</li>
</ul>
<p>今天讲的是XMPP的登陆注册部分,废话不多说:</p>
<h3 id="1-登陆注册部分常用的对象"><a href="#1-登陆注册部分常用的对象" class="headerlink" title="1.登陆注册部分常用的对象"></a>1.登陆注册部分常用的对象</h3><ul>
<li>XMPPStream XMPP通道:负责XMPP信息的传输以及传输状态等</li>
<li>XMPPReconnect 自动连接</li>
</ul>
<h3 id="2-准备工作"><a href="#2-准备工作" class="headerlink" title="2.准备工作"></a>2.准备工作</h3><p>1.创建一个单例类名为XMPPManager,负责XMPP相关管理工作,比如各类登陆注册模块的激活,实现都在这里进行处理.<br>2.创建一个单例类名为UserManager,负责用户的账号密码的管理以及获取用户信息等方面.</p>
<h3 id="3-登录注册实现部分"><a href="#3-登录注册实现部分" class="headerlink" title="3.登录注册实现部分"></a>3.登录注册实现部分</h3><h4 id="3-1实现原理"><a href="#3-1实现原理" class="headerlink" title="3.1实现原理"></a>3.1实现原理</h4><p>这里阐述下实现原理,具体实现过程请参考下部分代码以及项目内容.</p>
<pre><code> 1.导入XMPPStream,XMPPReonnect头文件
 2.激活XMPPStream,XMPPReconnect模块并设置代理
 3.登录的流程：
  xmpp的登录流程是，
  3.1 传递 JID , Host , Port 先连接上服务器 
  3.2连接成功了 再 发送密码到服务器 ，
  3.3授权成功 或者 授权失败.这就代表登陆成功或失败,成功了则跳到微信主界面

 4.注册的流程:
   4.1xmpp的注册流程是， 传递 JID , Host , Port 先连接上服务器 :
通过JID连接成功
连接成功则会自动调用XMPPStreamDelegatexmppStreamDidConnect 代理方法
然后在通过代理方法调用 XMPPStream的发送密码的方法authenticateWithPassword
   4.2连接成功了 再 发送注册密码到服务器 
   4.3注册成功 或者 失败,注册成功了跳到登陆界面,进行登陆

共同点：
不管你jid存不存在 都能连接到服务器。

不同点:
发送的是授权密码 还是 发送注册密码 就是决定你是登录还是注册.
5.在登陆注册页面进行调用方法并传递状态
</code></pre><p><strong>注意:<br>  1.连接到服务器后,对于是登陆还是注册的判断<br>  2.登陆成功后需要发送一个在线状态消息,离线了需要发送离线状态消息<br>  3.在UserManager中登陆用户信息和注册用户信息分清楚<br>  4.XMPPStream代理方法执行的顺序先后<br>  5.block对于登陆注册状态的提示<br>  6.对于XMPP JID的理解,用户名@服务器地址.设备信息(可选)</strong><br>    详细请看demo<br>  7.这个demo里登录名就是密码,不影响使用,请注意</p>
<h4 id="3-2XMPPManager部分"><a href="#3-2XMPPManager部分" class="headerlink" title="3.2XMPPManager部分"></a>3.2XMPPManager部分</h4><h5 id="3-2-1单例类"><a href="#3-2-1单例类" class="headerlink" title="3.2.1单例类"></a>3.2.1单例类</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#pragma mark 创建XMPPManager单例类</span><br><span class="line">singleton_m(manager)</span><br></pre></td></tr></table></figure>
<h5 id="3-2-2创建XMPPStream对象"><a href="#3-2-2创建XMPPStream对象" class="headerlink" title="3.2.2创建XMPPStream对象"></a>3.2.2创建XMPPStream对象</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 登录注册什么的都是和服务器交互,所以我们用到的类就是XMPPStream</span><br><span class="line">- (void)connect &#123;</span><br><span class="line">    if (!self.stream) &#123;</span><br><span class="line">        // 创建XMPPStream,只需要初始化一次,所以加判断</span><br><span class="line">        self.stream = [[XMPPStream alloc] init];</span><br><span class="line">        // 设置stream的域名和端口号</span><br><span class="line">        self.stream.hostName = kHostName;</span><br><span class="line">        self.stream.hostPort = kHostPort;</span><br><span class="line">        // 添加代理 连接成功后调用传密码的方法</span><br><span class="line">        [self.stream addDelegate:self delegateQueue:dispatch_get_main_queue()];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// 连接服务器</span><br><span class="line">- (void)connectToServer &#123;</span><br><span class="line">    // 判断是否连接成功过</span><br><span class="line">    if (![self.stream isConnected]) &#123;</span><br><span class="line">        // 连接到服务器</span><br><span class="line">        NSError *error;</span><br><span class="line">        [self.stream connectWithTimeout:XMPPStreamTimeoutNone error:&amp;error];</span><br><span class="line">        if (error) &#123;</span><br><span class="line">            NSLog(@&quot;%@&quot;,error);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // 连接成功则会自动调用XMPPStreamDelegatexmppStreamDidConnect 代理方法</span><br><span class="line">            // 然后在通过代理方法调用 XMPPStream的发送密码的方法authenticateWithPassword</span><br><span class="line">            NSLog(@&quot;连接成功&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-2-3-用户登陆-使用登陆JID用户名"><a href="#3-2-3-用户登陆-使用登陆JID用户名" class="headerlink" title="3.2.3 用户登陆,使用登陆JID用户名"></a>3.2.3 用户登陆,使用登陆JID用户名</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- (void)xmppUserLogin:(UserSatateBlock)block &#123;</span><br><span class="line">    // block赋值给全局变量,在代理方法中调用block传递登陆信息</span><br><span class="line">    self.block = block;</span><br><span class="line">    </span><br><span class="line">    // 不管登陆几次,每次登陆之前都要先把连接断开</span><br><span class="line">    [self.stream disconnect];</span><br><span class="line">    </span><br><span class="line">    // 初始化XMPPPStream</span><br><span class="line">    [self connect];</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     *  因为在调用之前,在userDefault中存储的是登陆用户的名字</span><br><span class="line">        所以在这里获取用户的名字</span><br><span class="line">     */</span><br><span class="line">    UserManager *user = [UserManager sharedmanager];</span><br><span class="line">    [user readLoginInfo];</span><br><span class="line">    // 设置XMPPStream的JID   : yoyu@127.0.0.1.iPhone</span><br><span class="line">    self.stream.myJID = [XMPPJID jidWithUser:user.loginName domain:kHostName resource:@&quot;iPhone&quot;];</span><br><span class="line">    </span><br><span class="line">    // 通过读取UserDefault中的name连接服务器</span><br><span class="line">    [self connectToServer];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-2-4用户注册-使用注册JID用户名"><a href="#3-2-4用户注册-使用注册JID用户名" class="headerlink" title="3.2.4用户注册,使用注册JID用户名"></a>3.2.4用户注册,使用注册JID用户名</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (void)xmppUserRegist:(UserSatateBlock)block &#123;</span><br><span class="line">    self.block = block;</span><br><span class="line">    </span><br><span class="line">    // 不管登陆几次,每次登陆之前都要先把连接断开</span><br><span class="line">    [self.stream disconnect];</span><br><span class="line">    </span><br><span class="line">    // 初始化XMPPPStream</span><br><span class="line">    [self connect];</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     *  因为在调用之前,在userDefault中存储的是注册用户的名字</span><br><span class="line">        所以在这里获取用户的名字</span><br><span class="line">     */</span><br><span class="line">    UserManager *user = [UserManager sharedmanager];</span><br><span class="line">    [user readRegistInfo];</span><br><span class="line">    // 设置XMPPStream的JID   : yoyu@127.0.0.1.iPhone</span><br><span class="line">    self.stream.myJID = [XMPPJID jidWithUser:user.registName domain:kHostName resource:@&quot;iPhone&quot;];</span><br><span class="line">    </span><br><span class="line">    // 通过读取UserDefault中的name连接服务器</span><br><span class="line">    [self connectToServer];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-2-5用户注销"><a href="#3-2-5用户注销" class="headerlink" title="3.2.5用户注销"></a>3.2.5用户注销</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (void)xmppUserLogout &#123;</span><br><span class="line">    // 发送离线状态</span><br><span class="line">    [self sendOfflineMessage];</span><br><span class="line">    </span><br><span class="line">    // 断开连接</span><br><span class="line">    [self.stream disconnect];</span><br><span class="line">    </span><br><span class="line">    // 跳转到登陆界面</span><br><span class="line">    UIWindow *window = [[UIApplication sharedApplication].delegate window];</span><br><span class="line">    UIStoryboard *storyBoard = [UIStoryboard storyboardWithName:@&quot;LoginAndRegist&quot; bundle:nil];</span><br><span class="line">    window.rootViewController = [storyBoard instantiateInitialViewController];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-2-6XMPPStreamDelegate连接服务器状态"><a href="#3-2-6XMPPStreamDelegate连接服务器状态" class="headerlink" title="3.2.6XMPPStreamDelegate连接服务器状态"></a>3.2.6XMPPStreamDelegate连接服务器状态</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">#pragma mark -- XMPPStreamDelegate</span><br><span class="line">/**</span><br><span class="line"> *  登录的流程：</span><br><span class="line">    xmpp的登录流程是， 传递 JID , Host , Port 先连接上服务器 ，连接成功了 再 发送密码到服务器 ，授权成功 或者 授权失败</span><br><span class="line"> </span><br><span class="line">    注册的流程：</span><br><span class="line">    xmpp的注册流程是， 传递 JID , Host , Port 先连接上服务器 ，连接成功了 再 发送注册密码到服务器 ，注册成功 或者 失败</span><br><span class="line"> </span><br><span class="line">    共同点：</span><br><span class="line">    不管你jid存不存在 都能连接到服务器。</span><br><span class="line"> </span><br><span class="line">    不同点:</span><br><span class="line">    发送的是授权密码 还是 发送注册密码 就是决定你是登录还是注册</span><br><span class="line"></span><br><span class="line"> */</span><br><span class="line">/**</span><br><span class="line">    通过JID连接成功</span><br><span class="line"> *  连接成功则会自动调用XMPPStreamDelegatexmppStreamDidConnect 代理方法</span><br><span class="line">    然后在通过代理方法调用 XMPPStream的发送密码的方法authenticateWithPassword</span><br><span class="line"> */</span><br><span class="line">#pragma mark -- 连接成功</span><br><span class="line">- (void)xmppStreamDidConnect:(XMPPStream *)sender &#123;</span><br><span class="line">    NSLog(@&quot;通过JID建立连接成功&quot;);</span><br><span class="line">    /**</span><br><span class="line">     *  发送密码进行授权登陆</span><br><span class="line">        分登陆密码</span><br><span class="line">        和注册密码</span><br><span class="line">        需要判断</span><br><span class="line">     */</span><br><span class="line">    UserManager *user = [UserManager sharedmanager];</span><br><span class="line">    //[user readUserInfo];</span><br><span class="line">    NSError *error = nil;</span><br><span class="line">    NSLog(@&quot;%@&quot;,user.loginName);</span><br><span class="line">    NSLog(@&quot;---%@&quot;,user.registName);</span><br><span class="line">    if (user.loginName) &#123;</span><br><span class="line">        // 发送登陆密码</span><br><span class="line">        [self.stream authenticateWithPassword:user.loginPsw error:&amp;error];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // 发送注册密码</span><br><span class="line">        [self.stream registerWithPassword:user.registPsw error:&amp;error];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark -- 连接失败,与服务器断开连接(例如网络原因)</span><br><span class="line">- (void)xmppStreamDidDisconnect:(XMPPStream *)sender withError:(NSError *)error &#123;</span><br><span class="line">    NSLog(@&quot;通过JID建立连接失败,与服务器断开连接&quot;);</span><br><span class="line">    if (self.block) &#123;</span><br><span class="line">        self.block(XMPPUserStateTypeOther);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 发送通知:状态2表示连接服务器失败</span><br><span class="line">    [[NSNotificationCenter defaultCenter] postNotificationName:kLoginStateNotification object:nil userInfo:@&#123;@&quot;state&quot;:@&quot;3&quot;&#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-2-7XMPPStreamDelegate登陆"><a href="#3-2-7XMPPStreamDelegate登陆" class="headerlink" title="3.2.7XMPPStreamDelegate登陆"></a>3.2.7XMPPStreamDelegate登陆</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> *  属于登陆方面</span><br><span class="line"> */</span><br><span class="line">#pragma mark -- 授权登陆成功</span><br><span class="line">-(void)xmppStreamDidAuthenticate:(XMPPStream *)sender&#123;</span><br><span class="line">    NSLog(@&quot;授权登陆成功&quot;);</span><br><span class="line">    if (self.block) &#123;</span><br><span class="line">        self.block(XMPPUserStateTypeSuccess);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 授权登陆成功后,跳转到主界面</span><br><span class="line">    UIWindow *window = [[UIApplication sharedApplication].delegate window];</span><br><span class="line">    UIStoryboard *storyBoard = [UIStoryboard storyboardWithName:@&quot;Main&quot; bundle:nil];</span><br><span class="line">    window.rootViewController = [storyBoard instantiateInitialViewController];</span><br><span class="line">    </span><br><span class="line">    // 同时要发送一个在线的信息</span><br><span class="line">    [self sendOnlineMessage];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark -- 授权登陆失败</span><br><span class="line">-(void)xmppStream:(XMPPStream *)sender didNotAuthenticate:(DDXMLElement *)error&#123;</span><br><span class="line">    NSLog(@&quot;授权登陆失败&quot;);</span><br><span class="line">    if (self.block) &#123;</span><br><span class="line">        self.block(XMPPUserStateTypeFaild);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-2-8XMPPStreamDelegate注册"><a href="#3-2-8XMPPStreamDelegate注册" class="headerlink" title="3.2.8XMPPStreamDelegate注册"></a>3.2.8XMPPStreamDelegate注册</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> *  属于注册方面</span><br><span class="line"> */</span><br><span class="line">#pragma mark -- 注册成功</span><br><span class="line">- (void)xmppStreamDidRegister:(XMPPStream *)sender&#123;</span><br><span class="line">    NSLog(@&quot;注册成功&quot;);</span><br><span class="line">    if (self.block) &#123;</span><br><span class="line">        self.block(XMPPUserStateTypeSuccess);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark -- 注册失败</span><br><span class="line">- (void)xmppStream:(XMPPStream *)sender didNotRegister:(NSXMLElement *)error&#123;</span><br><span class="line">    NSLog(@&quot;注册失败&quot;);</span><br><span class="line">    if (self.block) &#123;</span><br><span class="line">        self.block(XMPPUserStateTypeFaild);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-2-7登陆状态发送"><a href="#3-2-7登陆状态发送" class="headerlink" title="3.2.7登陆状态发送"></a>3.2.7登陆状态发送</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#pragma mark ******************************</span><br><span class="line">#pragma mark - 登陆成功后,给服务器发送一个在线消息:上线了</span><br><span class="line">/**</span><br><span class="line">    presence表示用户状态</span><br><span class="line"> </span><br><span class="line">   presence 的状态：</span><br><span class="line">        available 上线</span><br><span class="line">        away 离开</span><br><span class="line">        do not disturb 忙碌</span><br><span class="line">        unavailable 下线</span><br><span class="line"> */</span><br><span class="line">- (void)sendOnlineMessage &#123;</span><br><span class="line">    /**</span><br><span class="line">     *  关于用户的上线和下线，需要用到一个类XMPPPresence 类。这个类是XMPPElement的子类，主要用来管理某些信息的展现。首先要实例化一个对象，这其中会用到一个presenceWithType 方法，有两个选择@&quot;unavailable&quot;代表下线，@&quot;available&quot;代表上线，一般情况上线的时候后面就可以直接省略。</span><br><span class="line">     */</span><br><span class="line">    XMPPPresence *pre = [XMPPPresence presenceWithType:@&quot;available&quot;];</span><br><span class="line">    // XMPPPresence *pre = [XMPPPresence presence];</span><br><span class="line">    [self.stream sendElement:pre];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark - 离线时,给服务器发送一个在线消息:下线了</span><br><span class="line">- (void)sendOfflineMessage &#123;</span><br><span class="line">    XMPPPresence *pre = [XMPPPresence presenceWithType:@&quot;unavailable&quot;];</span><br><span class="line">    [self.stream sendElement:pre];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.3登陆注册页面<br>  这个部分就不详细介绍了,可以进demo查阅</p>
<p>未完待续…</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/08/20/XMPP/(%E4%B9%9D)%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E4%B9%8BXMPPFramework%E7%AE%80%E4%BB%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/android-chrome-384x384.png">
      <meta itemprop="name" content="HuiYou Hua">
      <meta itemprop="description" content="iOS 开发相关日常总结记录。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuiYouHua">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/08/20/XMPP/(%E4%B9%9D)%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E4%B9%8BXMPPFramework%E7%AE%80%E4%BB%8B/" class="post-title-link" itemprop="url">(九)即时通讯之XMPPFramework简介</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-08-20 00:09:53" itemprop="dateCreated datePublished" datetime="2016-08-20T00:09:53+08:00">2016-08-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/XMPP/" itemprop="url" rel="index"><span itemprop="name">XMPP</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>关于使用XMPPFramework完成即时通讯请继续关注后面系类内容.</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/b5aa4238d2bf">即时通讯之XMPPFramework导入</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/robbiehanson/XMPPFramework">XMPPFramework</a>是一个OS X/iOS平台的开源项目，使用Objective-C实现了XMPP协议（RFC-3920），同时还提供了用于读写XML的工具，大大简化了基于XMPP的通信应用的开发,是对XMPP的一次封装,使得我们更好的使用XMPP协议。</p>
<h3 id="XMPP中常用对象们"><a href="#XMPP中常用对象们" class="headerlink" title="XMPP中常用对象们"></a>XMPP中常用对象们</h3><p>XMPPStream：xmpp基础服务类</p>
<p>XMPPRoster：好友列表类</p>
<p>XMPPRosterCoreDataStorage：好友列表（用户账号）在core data中的操作类</p>
<p>XMPPvCardCoreDataStorage：好友名片（昵称，签名，性别，年龄等信息）在core data中的操作类</p>
<p>XMPPvCardTemp：好友名片实体类，从数据库里取出来的都是它</p>
<p>xmppvCardAvatarModule：好友头像</p>
<p>XMPPReconnect：如果失去连接,自动重连</p>
<p>XMPPRoom：提供多用户聊天支持</p>
<p>XMPPPubSub：发布订阅</p>
<p>XMPPMessageArchiving: 聊天信息模块</p>
<p>XMPPMessageArchivingCoreDataStorage: 聊天信息在数据库中的操作类</p>
<p>这些模块使用大都是需要先激活再使用,具体的可以关注接下来的文章</p>
<h3 id="下面是XMPPFramework几个常用到的扩展。"><a href="#下面是XMPPFramework几个常用到的扩展。" class="headerlink" title="下面是XMPPFramework几个常用到的扩展。"></a>下面是XMPPFramework几个常用到的扩展。</h3><h3 id="协议简介"><a href="#协议简介" class="headerlink" title="协议简介"></a>协议简介</h3><p>XEP-0009</p>
<p>在两个XMPP实体间传输XML-RPC编码请求和响应</p>
<p>XEP-0006</p>
<p>使能与网络上某个XMPP实体间的通信</p>
<p>XEP-0045</p>
<p>多人聊天相关协议</p>
<p>XEP-0054</p>
<p>名片格式的标准文档</p>
<p>XEP-0060</p>
<p>提供通用公共订阅功能</p>
<p>XEP-0065</p>
<p>两个XMPP用户之间建立一个带外流，主要用于文件传输</p>
<p>XEP-0082</p>
<p>日期和时间信息的标准化表示</p>
<p>XEP-0085</p>
<p>聊天对话中通知用户状态</p>
<p>XEP-0100</p>
<p>表述了XMPP客户端与提供传统的IM服务的代理网关之间交换的最佳实践</p>
<p>XEP-0115</p>
<p>广播和动态发现客户端、设备、或一般实体能力。</p>
<p>XEP-0136</p>
<p>为服务端备份和检索XMPP消息定义机制和偏好设置</p>
<p>XEP-0153</p>
<p>用于交换用户头像</p>
<p>XEP-0184</p>
<p>消息送达回执协议</p>
<p>XEP-0199</p>
<p>XMPP ping 协议</p>
<p>XEP-0202</p>
<p>用于交换实体间的本地时间信息</p>
<p>XEP-0203</p>
<p>用于延迟发送</p>
<p>XEP-0224</p>
<p>引起另一个用户注意的协议</p>
<p>详细的协议，点击<a target="_blank" rel="noopener" href="http://xmpp.org/xmpp-protocols/xmpp-extensions/">这里</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/08/20/XMPP/(%E5%85%AB)%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E4%B9%8BXMPPFramework%E5%AF%BC%E5%85%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/android-chrome-384x384.png">
      <meta itemprop="name" content="HuiYou Hua">
      <meta itemprop="description" content="iOS 开发相关日常总结记录。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuiYouHua">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/08/20/XMPP/(%E5%85%AB)%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E4%B9%8BXMPPFramework%E5%AF%BC%E5%85%A5/" class="post-title-link" itemprop="url">(八)即时通讯之XMPPFramework导入</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-08-20 00:08:53" itemprop="dateCreated datePublished" datetime="2016-08-20T00:08:53+08:00">2016-08-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/XMPP/" itemprop="url" rel="index"><span itemprop="name">XMPP</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>XMPPFramework框架的导入有两种方式<br>1.通过cocopods进行配置,比较方便,但某些时候可能会配置不成功.<br>2.手动配置.需要导入XMPPFramework矿建并配置相关依赖以及一些处理,较为麻烦.</p>
</blockquote>
<p><strong>下面介绍的就是手动配置XMPP框架 </strong></p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>在提供的Xcode示例项目中，包含有在iOS中使用XMPPFramework的演示项目。您可以在Xcode/iPhoneXMPP文件夹中找到它。该项目的设计并不是为了演示一个完整的商业应用，而仅是为了演示如何使用XMPPFramework框架，并提供有iOS平台上需要使用的具体代码。您可以随意修改及测试该项目，并浏览AppDelegate文件中的代码。提示，该示例程序仅使用了框架中的一小部分功能。<br>本文档提供了如何将XMPPFramework框架添加到iOS项目的详细说明，您也可以参照iPhoneXMPP项目中的具体引用。<br>提示：请按照以下步骤逐一执行，而不要省略或者跳过某个步骤。</p>
<ul>
<li><p><strong>第一步</strong><br>使用源代码管理器检出最新版本的项目。默认的分支包含有最新稳定版本的代码。<br>github地址:<a target="_blank" rel="noopener" href="https://github.com/robbiehanson/XMPPFramework">https://github.com/robbiehanson/XMPPFramework</a><br>下载对应的压缩包并解压缩</p>
</li>
<li><p><strong>第二步</strong><br>尽管本框架包含有对其他项目的依赖，不过您已无需再使用git去分别克隆这些项目。在克隆XMPPFramework框架的同时，这些项目会被同时克隆并保存在Vendor文件夹中。接下来，我们将逐一确认每一个依赖，以确保在完成最后一步工作之后，能够正常编译项目。<br>第一个依赖是<a target="_blank" rel="noopener" href="https://github.com/robbiehanson/CocoaLumberjack">CocoaLumberjack</a>，这是XMPPFramework框架使用的日志框架。<br>（有关日志框架的进一步信息，可以参见XMPPFramework的介绍文档，另外在Lumberjack的项目主页中也提供有大量的文档。）<br>将Vendor/CocoaLumberjack复制并添加入Xcode项目。<br>Lumberjack不包含任何子依赖或特殊要求的框架。<br>现在，请确认您的项目可以正常编译。</p>
</li>
<li><p><strong>第三步</strong><br>第二个依赖是CocoaAsyncSocket，这是XMPPFramework框架使用的底层网络框架。<br>将Vendor/CocoaAsyncSocket复制并添加入Xcode项目。<br>要使用此依赖，需要将苹果的<strong>CFNetwork</strong>框架添加到项目。<br>要使用此依赖，还需要将苹果的<strong>Security</strong>框架添加到项目。<br>现在，请确认您的项目可以正常编译。</p>
</li>
<li><p><strong>第四步</strong><br>第三个依赖是KissXML，由于苹果并没有针对iOS提供NSXML类以处理NSXMLDocument、NSXMLElement、NSXMLNode，因此我们使用KissXML取而代之。<br>将Vendor/KissXML复制并添加入Xcode项目。<br>由于KissXML内部使用到libxml2。因此还需要告诉Xcode在哪里可以找到libxml2的头文件，并且在编译完成后链接libxml2编译库。要做到这两点，在项目的编译设置中设置以下两条编译指令即可：</p>
</li>
</ul>
<ol>
<li>Other Link Flags = -lxml2</li>
<li>Header Search Paths = /usr/include/libxml2<br>执行完上述操作后，请确认您的项目可以正常编译。</li>
</ol>
<ul>
<li><p><strong>第五步</strong><br>第四个以及最后一个依赖是libidn。将以下文件添加到项目中：<br>Vendor/libidn/idn-int.h<br>Vendor/libidn/stringprep.h<br>Vendor/libidn/libidn.a<br>上述最后一个文件libidn.a是一个静态库，支持包括：x86*64、i386、ppc、armv6、armv7等多种架构。因而该文件的个头也不小，大约有1.7M。但是不用担心，编译器会在编译时仅提取架构所需的内容，并且只会提取被使用的那一部分，而由于框架中仅仅只用到了该静态库中很小的一部分内容。换言之，该静态库的使用不会明显增加您应用程序的大小！<br>注释：libidn的源代码包含在libidn-1.15.tar.gz中。不过很显然，没有必要将其添加到项目之中。<br>执行完上述操作后，请确认您的项目可以正常编译。</p>
</li>
<li><p><strong>第六步</strong><br>将以下文件夹复制并添加入Xcode项目：<br>Authentication<br>Categories<br>Core<br>Utilities<br>另外，还需将libresolv.dylib添加至Xcode项目。<br>执行完上述操作后，请确认您的项目可以正常编译。</p>
</li>
</ul>
<h4 id="大功告成"><a href="#大功告成" class="headerlink" title="大功告成!!!"></a>大功告成!!!</h4><p>至此，您已经准备好在项目中使用XMPPFramework框架了。后续的相关操作请参见：Intro to XMPPFramework文档。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="HuiYou Hua"
      src="/images/android-chrome-384x384.png">
  <p class="site-author-name" itemprop="name">HuiYou Hua</p>
  <div class="site-description" itemprop="description">iOS 开发相关日常总结记录。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">47</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HuiYou Hua</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  




  
<script src="/js/local-search.js"></script>













    <div id="pjax">
  

  

  


    </div>
</body>
</html>
